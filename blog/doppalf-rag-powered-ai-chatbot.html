<!DOCTYPE html><html lang="en"><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Maven+Pro&amp;family=Share+Tech+Mono&amp;family=Source+Sans+Pro&amp;family=Ubuntu&amp;display=swap" data-optimized-fonts="true"/><meta charSet="utf-8" class="jsx-1085971570"/><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-1085971570"/><meta name="description" content="Build a full-stack RAG-powered AI chatbot like ChatGPT to give LLM your personality with Python, FastAPI, Llamaindex, Cohere, Qdrant, Next.js (Typescript), and Tailwind CSS." class="jsx-1085971570"/><meta name="author" content="Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="keywords" content="python,llm,next-js,llamaindex,tailwind-css,typescript,fastapi,rag,cohere,qdrant,cohere-ai,ai-chatbot,llm,chatbot,chatgpt" class="jsx-1085971570"/><meta property="og:title" content="Doppalf: RAG powered full-stack AI chatbot like ChatGPT- Santha Lakshmi Narayana" class="jsx-1085971570"/><meta property="og:description" content="Build a full-stack RAG-powered AI chatbot like ChatGPT to give LLM your personality with Python, FastAPI, Llamaindex, Cohere, Qdrant, Next.js (Typescript), and Tailwind CSS." class="jsx-1085971570"/><meta property="og:url" content="https://santhalakshminarayana.github.io/blog/doppalf-rag-powered-ai-chatbot" class="jsx-1085971570"/><meta property="og:image" content="https://santhalakshminarayana.github.io/images/doppalf-rag-powered-ai-chatbot/doppalf-rag-powered-ai-chatbot.jpg" class="jsx-1085971570"/><meta property="og:type" content="article" class="jsx-1085971570"/><meta property="og:article:publisher" content="https://santhalakshminarayana.github.io/" class="jsx-1085971570"/><meta property="og:site_name" content="Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="twitter:card" content="summary_large_image" class="jsx-1085971570"/><meta name="twitter:title" content="Doppalf: RAG powered full-stack AI chatbot like ChatGPT- Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="twitter:description" content="Build a full-stack RAG-powered AI chatbot like ChatGPT to give LLM your personality with Python, FastAPI, Llamaindex, Cohere, Qdrant, Next.js (Typescript), and Tailwind CSS." class="jsx-1085971570"/><meta name="twitter:url" content="https://santhalakshminarayana.github.io/blog/doppalf-rag-powered-ai-chatbot" class="jsx-1085971570"/><meta name="twitter:site" content="@santhalakshminarayana" class="jsx-1085971570"/><meta name="twitter:image" content="https://santhalakshminarayana.github.io/images/doppalf-rag-powered-ai-chatbot/doppalf-rag-powered-ai-chatbot.jpg" class="jsx-1085971570"/><meta name="twitter:creator" content="@santhalakshminarayana" class="jsx-1085971570"/><link rel="icon" href="/images/santha-lakshmi-narayana-logo.png?" class="jsx-1085971570"/><link rel="canonical" href="https://santhalakshminarayana.github.io/blog/doppalf-rag-powered-ai-chatbot" class="jsx-1085971570"/><title class="jsx-1085971570">Doppalf: RAG powered full-stack AI chatbot like ChatGPT- Santha Lakshmi Narayana</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous" class="jsx-1085971570"/><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/b1be9be44572118d40d2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b1be9be44572118d40d2.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-2b6f4fb4c650415a78b4.js" defer=""></script><script src="/_next/static/chunks/framework.1b3b121feae4c8ce410b.js" defer=""></script><script src="/_next/static/chunks/commons.5b2d72a8e34e4f7cda46.js" defer=""></script><script src="/_next/static/chunks/main-d372fe187139d1f38e70.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8dd04848a34b8c116228.js" defer=""></script><script src="/_next/static/chunks/d0447323.b45849b482775ab7aa09.js" defer=""></script><script src="/_next/static/chunks/773f402080c38a523cb0b4f52dac49b5097e45fc.27dcfa1daccdb688cf4e.js" defer=""></script><script src="/_next/static/chunks/6188d020c9511bd1e7ae4c1c2034aa4e99a1704e.9b7f5c8773315bea6b89.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-94e8c9a7d510c6bd134a.js" defer=""></script><script src="/_next/static/XrdYHN_JN9xv8GJ3wA13S/_buildManifest.js" defer=""></script><script src="/_next/static/XrdYHN_JN9xv8GJ3wA13S/_ssgManifest.js" defer=""></script><style id="__jsx-3242260268">.tags.jsx-3242260268{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:1vw 5vw 1vw 5vw;background-color:#fffecb;border-bottom:5px solid #071013;}.tags.jsx-3242260268 a.jsx-3242260268{font-family:"Share Tech Mono",monospace;color:#1d2b35;margin:0 1em 0 1em;-webkit-text-decoration:none;text-decoration:none;border-bottom:1px dashed #fb232e;}.tags.jsx-3242260268 a.jsx-3242260268:hover{background:#20a4f3;color:#fffecb;border-bottom:1px dashed #fffecb;}.tags.jsx-3242260268 a.jsx-3242260268:active{background:#fb232e;}</style><style id="__jsx-90057834">.header-container.jsx-90057834{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:10px 5vw 10px 5vw;background:#1d2b35;}.header-left.jsx-90057834{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.header-left.jsx-90057834 a.jsx-90057834{font-family:"Source Sans Pro",sans-serif;-webkit-text-decoration:none;text-decoration:none;color:#ffaa33;}img.jsx-90057834{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;width:calc(1.2rem + 1vw);max-width:calc(1.2rem + 1vw);height:auto;margin:0 5px 0 5px;}img.jsx-90057834:hover{cursor:pointer;}.header-left.jsx-90057834 a.jsx-90057834:hover{color:#20a4f3;}.header-left.jsx-90057834 a.jsx-90057834:active{color:#fb232e;}.header-right.jsx-90057834{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:3;-ms-flex:3;flex:3;-webkit-flex-direction:row-reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.header-right.jsx-90057834 a.jsx-90057834{padding:0 1vw 0 1vw;font-family:"Source Sans Pro",sans-serif;-webkit-text-decoration:none;text-decoration:none;color:#ffaa33;}.header-right.jsx-90057834 a.jsx-90057834:hover{color:#20a4f3;}.header-right.jsx-90057834 a.jsx-90057834:active{color:#fb232e;}@media screen and (max-width:920px){.header-container.jsx-90057834{padding:10px 2vw 10px 2vw;}#name.jsx-90057834{display:none;}img.jsx-90057834{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (max-width:480px){.header-container.jsx-90057834{padding:10px 2vw 10px 2vw;overflow-x:scroll;}}@media screen and (max-width:300px){img.jsx-90057834{display:none;}}</style><style id="__jsx-2944168904">.img-text.jsx-2944168904{display:block;text-align:center;font-family:"Source Sans Pro",sans-serif;font-size:calc(0.8rem + 0.1vw);color:#1d2b35;overflow-wrap:"break-word";}a.jsx-2944168904{margin:0;-webkit-text-decoration:none;text-decoration:none;color:#1d2b35;border-bottom:1px solid;}</style><style id="__jsx-1110062031">.file-name-container.jsx-1110062031{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;width:100%;max-width:100%;background-color:#1d2b35d9;padding:calc(0.5rem + 0.2vw);border-top-left-radius:5px;border-top-right-radius:5px;margin-top:1vh;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;}.file-name.jsx-1110062031{font-family:"Share Tech Mono",monospace;font-size:calc(0.9rem + 0.1vw);color:#fffecbf2;}</style><style id="__jsx-1393389675">.footer-container.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background:#1d2b35e6;padding:1vw 1vw 1vw 1vw;}.footer-container-links.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}.footer-links.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.link-item.jsx-1393389675{margin:0 1vw 0 1vw;}.link.jsx-1393389675{-webkit-text-decoration:none;text-decoration:none;cursor:pointer: background-color:yellow;}.link.jsx-1393389675:hover{color:black;}.copy-right-container.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-top:10px;}.copy-right-text.jsx-1393389675{font-family:'Maven Pro',sans-serif;font-size:calc(0.75rem + 0.1vw);color:#fffecb;}</style><style id="__jsx-1085971570">.blog-content.jsx-1085971570{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:100%;-ms-flex:100%;flex:100%;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:1vw 25vw 1vw 25vw;width:50vw;max-width:50vw;min-height:90vh;}@media screen and (max-width:980px){.blog-content.jsx-1085971570{margin:1vw 15vw 1vw 15vw;width:70vw;max-width:70vw;}}@media screen and (max-width:760px){.blog-content.jsx-1085971570{margin:1vw 5vw 1vw 5vw;width:90vw;max-width:90vw;}}</style><style data-href="https://fonts.googleapis.com/css2?family=Maven+Pro&family=Share+Tech+Mono&family=Source+Sans+Pro&family=Ubuntu&display=swap">@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/mavenpro/v36/7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX25nM.woff) format('woff')}@font-face{font-family:'Share Tech Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sharetechmono/v15/J7aHnp1uDWRBEqV98dVQztYldFc7pw.woff) format('woff')}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3aPA.woff) format('woff')}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgo6ew.woff) format('woff')}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/mavenpro/v36/7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nijpBh8CvRBOB1s.woff) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/mavenpro/v36/7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nmjpBh8CvRBOB1s.woff) format('woff');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/mavenpro/v36/7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nejpBh8CvRBOA.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Share Tech Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sharetechmono/v15/J7aHnp1uDWRBEqV98dVQztYldFcLowEFA87Heg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNa7lujVj9_mf.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qPK7lujVj9_mf.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNK7lujVj9_mf.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qO67lujVj9_mf.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qN67lujVj9_mf.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNq7lujVj9_mf.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7lujVj9w.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcg72nU6AF7xm.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C8A,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKew72nU6AF7xm.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcw72nU6AF7xm.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKfA72nU6AF7xm.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcQ72nU6AF7xm.woff2) format('woff2');unicode-range:U+0100-02BA,U+02BD-02C5,U+02C7-02CC,U+02CE-02D7,U+02DD-02FF,U+0304,U+0308,U+0329,U+1D00-1DBF,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKfw72nU6AFw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div style="min-height:100vh" class="jsx-1085971570"><div class="jsx-90057834 header"><div class="jsx-90057834 header-container"><div class="jsx-90057834 header-left"><img src="/images/santha-lakshmi-narayana-logo.png" alt="Logo" class="jsx-90057834"/><a id="name" class="jsx-90057834" href="/"><b class="jsx-90057834">Santha Lakshmi Narayana</b></a></div><div class="jsx-90057834 header-right"><a class="jsx-90057834" href="/about">About</a><a href="#" class="jsx-90057834">Tags</a><a class="jsx-90057834" href="/">Home</a></div></div><div style="display:none" class="jsx-90057834"><div class="jsx-3242260268 tags"><a class="jsx-3242260268" href="/tags/ai">#ai</a><a class="jsx-3242260268" href="/tags/system-design">#system-design</a><a class="jsx-3242260268" href="/tags/python">#python</a><a class="jsx-3242260268" href="/tags/go">#go</a><a class="jsx-3242260268" href="/tags/image-processing">#image-processing</a><a class="jsx-3242260268" href="/tags/opencv">#opencv</a><a class="jsx-3242260268" href="/tags/concurrency">#concurrency</a><a class="jsx-3242260268" href="/tags/python-performance">#python-performance</a><a class="jsx-3242260268" href="/tags/color-science">#color-science</a><a class="jsx-3242260268" href="/tags/react">#react</a><a class="jsx-3242260268" href="/tags/next-js">#next-js</a><a class="jsx-3242260268" href="/tags/flutter">#flutter</a></div></div></div><article class="jsx-1085971570 blog-content"><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/doppalf-rag-powered-ai-chatbot.jpg" alt="Doppalf: RAG powered fullstack AI chatbot like ChatGPT" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"></span></picture></p><h6 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#fb232e;margin:1vh 0 1vh 0;overflow-wrap:break-word">Published on: <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">May 24, 2024</strong></h6><h1 style="font-family:&#x27;Ubuntu&#x27;, sans-serif;font-size:calc(1rem + 1.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Doppalf: RAG-powered fullstack AI chatbot like ChatGPT</h1><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">I have built an end-to-end full-stack AI chatbot web application like ChatGPT. It&#x27;s powered with RAG (Retrieval Augmentation Generation) to give LLM my personality. Meaning, that LLM will behave like me and assume the character of <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Lakshmi Narayana</strong>. I have built this application with LLamaindex, Cohere AI, and the Qdrant database. The full tech stack is:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Docker</strong></li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Nginx</strong></li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">UI</strong>:<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Next.js (v14)</li><li>Typescript</li><li>Tailwind CSS</li></ul></li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Backend</strong>:<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Python (v3.12)</li><li>FastAPI</li><li>Llamaindex</li><li>Cohere AI</li><li>Qdrant Cloud</li></ul></li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/doppalf-response.gif" alt="Doppalf AI" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">Doppalf AI streaming response</span></span></picture></p><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Architecture</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/doppalf-arch.png" alt="Doppalf Architecture" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">Doppalf High level Architecture</span></span></picture></p><blockquote style="font-style:italic;background-color:#20a4f326;padding:10px;margin:1vh 0 1vh 0;border-left:5px solid #20a4f3e6"><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The whole project code can be found on GitHub for <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://github.com/santhalakshminarayana/doppalf">Doppalf</a>.</p></blockquote><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">For Doppalf, Docker has been used for container orchestration and Nginx as a reverse proxy. This application has a total three services (repos):</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>doppalf-rp (Nginx)</li><li>doppalf-ui (Next.js)</li><li>doppalf-ai (Python)</li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Each of the above repos has an individual <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Dockerfile</strong> with optimized configuration. The following are the Dockerfiles for individual services:</p><h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">doppalf-ui (Next.js)</h3><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Dockerfile</p></div><pre class="language-yaml:Dockerfile" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-yaml" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>FROM node</span><span class="token" style="color:#d4d4d4">:</span><span>21</span><span class="token" style="color:#d4d4d4">-</span><span>bullseye</span><span class="token" style="color:#d4d4d4">-</span><span>slim AS deps
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>WORKDIR /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>COPY package</span><span class="token" style="color:#569cd6">*.json</span><span> ./
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>EXPOSE 3001
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>ENV PORT 3001
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>ENV HOSTNAME &quot;0.0.0.0&quot;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>RUN npm ci
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#6a9955"># Development</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>From deps as dev
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>ENV NODE_ENV=development
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>COPY . .
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>CMD </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;npm&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;run&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;dev&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>FROM node</span><span class="token" style="color:#d4d4d4">:</span><span>21</span><span class="token" style="color:#d4d4d4">-</span><span>bullseye</span><span class="token" style="color:#d4d4d4">-</span><span>slim AS builder
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>WORKDIR /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>COPY </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>from=deps /app/node_modules ./node_modules
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span>COPY . .
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span>RUN npm run build
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>RUN npm prune </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>production
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span></span><span class="token" style="color:#6a9955"># Production</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span>FROM node</span><span class="token" style="color:#d4d4d4">:</span><span>21</span><span class="token" style="color:#d4d4d4">-</span><span>bullseye</span><span class="token" style="color:#d4d4d4">-</span><span>slim AS prod
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span>WORKDIR /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span>ENV NODE_ENV production
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span></span><span class="token" style="color:#6a9955"># Add nextjs user</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>RUN addgroup </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>system </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>gid 1001 nodejs
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span><span>RUN adduser </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>system </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>uid 1001 nextjs
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span><span></span><span class="token" style="color:#6a9955"># Set the permission for prerender cache</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span>RUN mkdir .next
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">31</span><span>RUN chown nextjs</span><span class="token" style="color:#d4d4d4">:</span><span>nodejs .next
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">32</span>USER nextjs
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">33</span><span></span><span class="token" style="color:#6a9955"># Automatically leverage output traces to reduce image size</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">34</span><span>COPY </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>from=builder </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>chown=nextjs</span><span class="token" style="color:#d4d4d4">:</span><span>nodejs /app/.next/static ./.next/static
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">35</span><span>COPY </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>from=builder </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>chown=nextjs</span><span class="token" style="color:#d4d4d4">:</span><span>nodejs /app/public ./public
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">36</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">37</span>EXPOSE 3001
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">38</span>ENV PORT 3001
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">39</span>ENV HOSTNAME &quot;0.0.0.0&quot;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">40</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">41</span><span>CMD </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;npm&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;start&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">42</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The above <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Dockerfile</strong> has a multi-stage build config for both <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">dev</em> and <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">prod</em> environments. The exact build stage to be used will be determined by configuration from <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">docker-compose.yaml</em>. By default, the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">dev</em> stage is used. The above configuration for <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">prod</em> is very optimal and reduces the final running docker image size due to Next.js optimizations.</p><h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">doppalf-ai (Python)</h3><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Dockerfile</p></div><pre class="language-yaml:Dockerfile" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-yaml" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#6a9955"># Why bookworm? https://pythonspeed.com/articles/base-image-python-docker-images/</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>FROM python</span><span class="token" style="color:#d4d4d4">:</span><span>3.12</span><span class="token" style="color:#d4d4d4">-</span><span>slim</span><span class="token" style="color:#d4d4d4">-</span><span>bookworm as base
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>WORKDIR /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>RUN apt</span><span class="token" style="color:#d4d4d4">-</span><span>get update </span><span class="token" style="color:#569cd6">&amp;&amp;</span><span> \
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    apt</span><span class="token" style="color:#d4d4d4">-</span><span>get install </span><span class="token" style="color:#d4d4d4">-</span><span>y </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>no</span><span class="token" style="color:#d4d4d4">-</span><span>install</span><span class="token" style="color:#d4d4d4">-</span><span>recommends gcc
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>COPY requirements.txt .
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>RUN pip wheel </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>no</span><span class="token" style="color:#d4d4d4">-</span><span>cache</span><span class="token" style="color:#d4d4d4">-</span><span>dir </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>no</span><span class="token" style="color:#d4d4d4">-</span><span>deps </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>wheel</span><span class="token" style="color:#d4d4d4">-</span><span>dir /app/wheels </span><span class="token" style="color:#d4d4d4">-</span><span>r requirements.txt
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>FROM python</span><span class="token" style="color:#d4d4d4">:</span><span>3.12</span><span class="token" style="color:#d4d4d4">-</span><span>slim</span><span class="token" style="color:#d4d4d4">-</span><span>bookworm as build
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>ENV PYTHONDONTWRITEBYTECODE=1
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>ENV PYTHONUNBUFFERED=1
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>WORKDIR /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span><span>COPY </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>from=base /app/wheels /app/wheels
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span>COPY </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>from=base /app/requirements.txt .
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>RUN pip install </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">-</span><span>no</span><span class="token" style="color:#d4d4d4">-</span><span>cache /app/wheels/*
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>COPY . /app
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>EXPOSE 4001
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span>CMD </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;python&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;main.py&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The above <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Dockerfile</strong> pulls Python 3.12 <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">slim-bookworm</em> docker image as opposed to the common <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">alpine</em> image. You can refer to the linked article for why. Here instead of normally installing requirements through <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">pip</em>, we install dependencies through <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">wheels</em> which optimizes the docker image build speed.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The Next.js service will be running on PORT <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">3001</em> and the Python service will run on <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">4001</em>.</p><h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">doppalf-rp (Nginx)</h3><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">And finally, Nginx configuration for forwarding the traffic to individual services are done as </p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">includes/proxy.conf</p></div><pre class="language-:includes/proxy.conf" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>proxy_set_header Host $host;
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>proxy_set_header X-Real-IP $remote_addr;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>proxy_set_header X-Forwarded-Proto $scheme;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>proxy_set_header X-Forwarded-Host $server_name;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>proxy_buffering off;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>proxy_request_buffering off;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>proxy_http_version 1.1;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span>proxy_intercept_errors on;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span></code></pre></div></pre><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Dockerfile</p></div><pre class="language-yaml:Dockerfile" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-yaml" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>From nginx</span><span class="token" style="color:#d4d4d4">:</span><span>stable</span><span class="token" style="color:#d4d4d4">-</span><span>alpine
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>RUN mkdir </span><span class="token" style="color:#d4d4d4">-</span><span>p /run/nginx
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>WORKDIR /run/nginx
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>COPY ./nginx.conf /etc/nginx/conf.d/default.conf
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>COPY ./includes /etc/nginx/includes/
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>EXPOSE 80
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>CMD </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;nginx&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;-g&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;daemon off;&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Nginx configruation for forwarding rules for different services</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">nginx.conf</p></div><pre class="language-:nginx.conf" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>server {
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span>    listen 80 default_server;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span>    listen [::]:80 default_server;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>    server_name _;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>    index index.html;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span>    location / {
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span>        proxy_pass http://doppalf-ui-service:3001;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>    }
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span>    location /doppalf-ai/v1 {
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>        proxy_pass http://doppalf-ai-service:4001;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span>        proxy_redirect off;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>        # SSE connection config
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>        proxy_set_header Connection &#x27;&#x27;;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span>        proxy_cache off;
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span>    }
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span>}
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:1.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">So, the root <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">/</em> request (127.0.0.1) will be forwarded to the Next.js UI service for the UI page, and any request with the prefix <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">/doppalf-ai/v1</em> will be forwarded to the Python AI service.</p><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Doppalf UI</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The UI has been built with Next.js (Typescript) and Tailwind CSS. It&#x27;s a single-page application that mainly contains an input box for providing Query and the response will be generated like ChatGPT where the UI will show the user and system messages. The AI-generated answer will be streamed like ChatGPT and rendered as Markdown. This has been done by Streaming the text from the Backend as <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">SSE (Server Sent Events)</strong> and reading those messages in Next.js using using Microsoft&#x27;s <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://www.npmjs.com/package/@microsoft/fetch-event-source">Fetch Event Source package</a> because normal browser SSE doesn&#x27;t support <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">POST</em> request.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/doppalf-ui-query-response.png" alt="Doppalf UI Landing Page" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">Showing User and System Message</span></span></picture></p><h4>UI Features include:</h4><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Dark mode</li><li>Streaming responses like ChatGPT</li><li>Auto-scroll to the bottom while generating the answer</li><li>New chat session</li></ul><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Doppalf AI</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The main part of this application is building the RAG pipeline and giving LLM a personal character that answers like me. For this, I have used Llamaindex for building the RAG pipeline, Cohere AI as LLM, and Qdrant Cloud for storing vector embeddings.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This costs me nothing as they both offer free APIs, you can get free <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://dashboard.cohere.com/api-keys">Cohere API trail Key</a> and 1 GB cluster for storing vectors in <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://cloud.qdrant.io">Qdrant Cloud API Key and URL</a>.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The web framework for providing APIs used was FastAPI and its support for streaming the response like SSE without using any extra configuration was a huge thumbs up for this kind of AI Chatbot application.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">For building the RAG pipeline, I have followed the following pipeline process:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Load Documents</li><li>Parse text into Sentences (as nodes) with Window size as 1</li><li>Get vector embeddings for each node (sentences) with Cohere Embeddings</li><li>Index the nodes and store the vector embeddings in the Qdrant cloud</li><li>Persist the index for re-use further runtimes</li><li>Build a Chat engine from the index with a retrieval strategy as &quot;Small-to-Big&quot; and with some buffered chat memory history</li><li>Provide the retrieved context and use Cohere Rerank for reranking the retrieved nodes</li><li>Synthesis the response using Cohere</li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/rag-pipeline.jpg" alt="RAG Pipeline" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">RAG pipeline</span></span></picture></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The complete code for the RAG pipeline using Llamaindex is </p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">rag.py</p></div><pre class="language-python:rag.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>core </span><span class="token" style="color:#569CD6">import</span><span> load_index_from_storage
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>core</span><span class="token" style="color:#d4d4d4">.</span><span>memory </span><span class="token" style="color:#569CD6">import</span><span> ChatMemoryBuffer
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>core</span><span class="token" style="color:#d4d4d4">.</span><span>node_parser </span><span class="token" style="color:#569CD6">import</span><span> SentenceWindowNodeParser
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>core</span><span class="token" style="color:#d4d4d4">.</span><span>postprocessor </span><span class="token" style="color:#569CD6">import</span><span> MetadataReplacementPostProcessor
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>embeddings</span><span class="token" style="color:#d4d4d4">.</span><span>cohere </span><span class="token" style="color:#569CD6">import</span><span> CohereEmbedding
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>llms</span><span class="token" style="color:#d4d4d4">.</span><span>cohere </span><span class="token" style="color:#569CD6">import</span><span> Cohere
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>postprocessor</span><span class="token" style="color:#d4d4d4">.</span><span>cohere_rerank </span><span class="token" style="color:#569CD6">import</span><span> CohereRerank
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span></span><span class="token" style="color:#569CD6">from</span><span> llama_index</span><span class="token" style="color:#d4d4d4">.</span><span>vector_stores</span><span class="token" style="color:#d4d4d4">.</span><span>qdrant </span><span class="token" style="color:#569CD6">import</span><span> QdrantVectorStore
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span></span><span class="token" style="color:#569CD6">from</span><span> qdrant_client </span><span class="token" style="color:#569CD6">import</span><span> QdrantClient
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span></span><span class="token" style="color:#569CD6">from</span><span> src</span><span class="token" style="color:#d4d4d4">.</span><span>config</span><span class="token" style="color:#d4d4d4">.</span><span>env </span><span class="token" style="color:#569CD6">import</span><span> ENV</span><span class="token" style="color:#d4d4d4">,</span><span> env_keys
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span></span><span class="token" style="color:#569CD6">from</span><span> src</span><span class="token" style="color:#d4d4d4">.</span><span>config</span><span class="token" style="color:#d4d4d4">.</span><span>logger </span><span class="token" style="color:#569CD6">import</span><span> get_logger
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span><span></span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">.</span><span>constants </span><span class="token" style="color:#569CD6">import</span><span> CHAT_PROMPT
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span><span>envk </span><span class="token" style="color:#d4d4d4">=</span><span> ENV</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span><span>logger </span><span class="token" style="color:#d4d4d4">=</span><span> get_logger</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span>index </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">None</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>chat_engine </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569cd6">None</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span></span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">load_rag</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#569cd6">None</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span>    </span><span class="token" style="color:#569CD6">global</span><span> index
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span>    </span><span class="token" style="color:#569CD6">global</span><span> chat_engine
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>    cdir </span><span class="token" style="color:#d4d4d4">=</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>getcwd</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span><span>    docs_dir </span><span class="token" style="color:#d4d4d4">=</span><span> envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;DOCS_DIR&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">28</span><span>    docs_path </span><span class="token" style="color:#d4d4d4">=</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>path</span><span class="token" style="color:#d4d4d4">.</span><span>join</span><span class="token" style="color:#d4d4d4">(</span><span>cdir</span><span class="token" style="color:#d4d4d4">,</span><span> docs_dir</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">29</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">30</span><span>    </span><span class="token" style="color:#6a9955"># check if any documents are provided for index</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">31</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#569CD6">not</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>path</span><span class="token" style="color:#d4d4d4">.</span><span>exists</span><span class="token" style="color:#d4d4d4">(</span><span>docs_path</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">32</span><span>        </span><span class="token" style="color:#569CD6">raise</span><span> FileNotFoundError</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Documents dir at path: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">docs_path</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178"> not exists.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">33</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> </span><span class="token" style="color:#569CD6">not</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>listdir</span><span class="token" style="color:#d4d4d4">(</span><span>docs_dir</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">34</span><span>        </span><span class="token" style="color:#569CD6">raise</span><span> FileNotFoundError</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Provide documents inside directory: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">docs_path</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178"> for indexing.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">35</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">36</span><span>    storage_dir </span><span class="token" style="color:#d4d4d4">=</span><span> envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;INDEX_STORAGE_DIR&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">37</span><span>    storage_path </span><span class="token" style="color:#d4d4d4">=</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>path</span><span class="token" style="color:#d4d4d4">.</span><span>join</span><span class="token" style="color:#d4d4d4">(</span><span>cdir</span><span class="token" style="color:#d4d4d4">,</span><span> storage_dir</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">38</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">39</span><span>    cohere_api_key </span><span class="token" style="color:#d4d4d4">=</span><span> envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;COHERE_API_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">40</span><span>    qdrant_api_key </span><span class="token" style="color:#d4d4d4">=</span><span> envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;QDRANT_API_KEY&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">41</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">42</span><span>    Settings</span><span class="token" style="color:#d4d4d4">.</span><span>llm </span><span class="token" style="color:#d4d4d4">=</span><span> Cohere</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">43</span><span>        api_key</span><span class="token" style="color:#d4d4d4">=</span><span>cohere_api_key</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">44</span><span>        model</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;command-r-plus&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">45</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">46</span><span>    Settings</span><span class="token" style="color:#d4d4d4">.</span><span>embed_model </span><span class="token" style="color:#d4d4d4">=</span><span> CohereEmbedding</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">47</span><span>        cohere_api_key</span><span class="token" style="color:#d4d4d4">=</span><span>cohere_api_key</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">48</span><span>        model_name</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;embed-english-v3.0&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">49</span><span>        input_type</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;search_document&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">50</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">51</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">52</span><span>    qd_client </span><span class="token" style="color:#d4d4d4">=</span><span> QdrantClient</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">53</span><span>        envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;QDRANT_CLOUD_URL&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">54</span><span>        api_key</span><span class="token" style="color:#d4d4d4">=</span><span>qdrant_api_key</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">55</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">56</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">57</span><span>    sentence_node_parser </span><span class="token" style="color:#d4d4d4">=</span><span> SentenceWindowNodeParser</span><span class="token" style="color:#d4d4d4">.</span><span>from_defaults</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">58</span><span>        window_size</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">59</span><span>        window_metadata_key</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;window&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">60</span><span>        original_text_metadata_key</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;original_text&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">61</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">62</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">63</span><span>    vector_store </span><span class="token" style="color:#d4d4d4">=</span><span> QdrantVectorStore</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">64</span><span>        client</span><span class="token" style="color:#d4d4d4">=</span><span>qd_client</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">65</span><span>        collection_name</span><span class="token" style="color:#d4d4d4">=</span><span>envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;COLLECTION_NAME&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">66</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">67</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">68</span><span>    </span><span class="token" style="color:#6a9955"># index was previously persisted</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">69</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>path</span><span class="token" style="color:#d4d4d4">.</span><span>exists</span><span class="token" style="color:#d4d4d4">(</span><span>storage_path</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">and</span><span> os</span><span class="token" style="color:#d4d4d4">.</span><span>listdir</span><span class="token" style="color:#d4d4d4">(</span><span>storage_path</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">70</span><span>        logger</span><span class="token" style="color:#d4d4d4">.</span><span>debug</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Using existing index.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">71</span><span>        storage_context </span><span class="token" style="color:#d4d4d4">=</span><span> StorageContext</span><span class="token" style="color:#d4d4d4">.</span><span>from_defaults</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">72</span><span>            vector_store</span><span class="token" style="color:#d4d4d4">=</span><span>vector_store</span><span class="token" style="color:#d4d4d4">,</span><span> persist_dir</span><span class="token" style="color:#d4d4d4">=</span><span>storage_path
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">73</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">74</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">75</span><span>        index </span><span class="token" style="color:#d4d4d4">=</span><span> load_index_from_storage</span><span class="token" style="color:#d4d4d4">(</span><span>storage_context</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">76</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">77</span><span>    </span><span class="token" style="color:#569CD6">else</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">78</span><span>        logger</span><span class="token" style="color:#d4d4d4">.</span><span>debug</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Creating new index for documents.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">79</span><span>        reader </span><span class="token" style="color:#d4d4d4">=</span><span> SimpleDirectoryReader</span><span class="token" style="color:#d4d4d4">(</span><span>input_dir</span><span class="token" style="color:#d4d4d4">=</span><span>docs_path</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">80</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">81</span><span>        all_docs </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">82</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> docs </span><span class="token" style="color:#569CD6">in</span><span> reader</span><span class="token" style="color:#d4d4d4">.</span><span>iter_data</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">83</span><span>            all_docs</span><span class="token" style="color:#d4d4d4">.</span><span>extend</span><span class="token" style="color:#d4d4d4">(</span><span>docs</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">84</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">85</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> doc </span><span class="token" style="color:#569CD6">in</span><span> all_docs</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">86</span><span>            logger</span><span class="token" style="color:#d4d4d4">.</span><span>debug</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;id: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">doc</span><span class="token string-interpolation" style="color:#d4d4d4">.</span><span class="token string-interpolation" style="color:#9cdcfe">doc_id</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">\nmetada: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">doc</span><span class="token string-interpolation" style="color:#d4d4d4">.</span><span class="token string-interpolation" style="color:#9cdcfe">metadata</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">87</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">88</span><span>        nodes </span><span class="token" style="color:#d4d4d4">=</span><span> sentence_node_parser</span><span class="token" style="color:#d4d4d4">.</span><span>get_nodes_from_documents</span><span class="token" style="color:#d4d4d4">(</span><span>all_docs</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">89</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">90</span><span>        storage_context </span><span class="token" style="color:#d4d4d4">=</span><span> StorageContext</span><span class="token" style="color:#d4d4d4">.</span><span>from_defaults</span><span class="token" style="color:#d4d4d4">(</span><span>vector_store</span><span class="token" style="color:#d4d4d4">=</span><span>vector_store</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">91</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">92</span><span>        index </span><span class="token" style="color:#d4d4d4">=</span><span> VectorStoreIndex</span><span class="token" style="color:#d4d4d4">(</span><span>nodes</span><span class="token" style="color:#d4d4d4">,</span><span> storage_context</span><span class="token" style="color:#d4d4d4">=</span><span>storage_context</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">93</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">94</span><span>        index</span><span class="token" style="color:#d4d4d4">.</span><span>storage_context</span><span class="token" style="color:#d4d4d4">.</span><span>persist</span><span class="token" style="color:#d4d4d4">(</span><span>persist_dir</span><span class="token" style="color:#d4d4d4">=</span><span>storage_path</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">95</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">96</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">97</span><span>    chat_engine </span><span class="token" style="color:#d4d4d4">=</span><span> index</span><span class="token" style="color:#d4d4d4">.</span><span>as_chat_engine</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">98</span><span>        chat_mode</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;condense_plus_context&quot;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">99</span><span>        memory</span><span class="token" style="color:#d4d4d4">=</span><span>ChatMemoryBuffer</span><span class="token" style="color:#d4d4d4">.</span><span>from_defaults</span><span class="token" style="color:#d4d4d4">(</span><span>token_limit</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">(</span><span>envk</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span>env_keys</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;MAX_BUFFER_MEMORY_TOKENS&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">100</span><span>        context_prompt</span><span class="token" style="color:#d4d4d4">=</span><span>CHAT_PROMPT</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">101</span><span>        similarity_top_k</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">102</span><span>        node_postprocessors</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#d4d4d4">[</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">103</span><span>            MetadataReplacementPostProcessor</span><span class="token" style="color:#d4d4d4">(</span><span>target_metadata_key</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;window&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">104</span><span>            CohereRerank</span><span class="token" style="color:#d4d4d4">(</span><span>api_key</span><span class="token" style="color:#d4d4d4">=</span><span>cohere_api_key</span><span class="token" style="color:#d4d4d4">,</span><span> top_n</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">105</span><span>        </span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">106</span><span>        verbose</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#569cd6">False</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">107</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">108</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">109</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">110</span><span></span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">chat</span><span class="token" style="color:#d4d4d4">(</span><span>query</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">111</span><span>    </span><span class="token" style="color:#569CD6">global</span><span> chat_engine
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">112</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">113</span><span>    response </span><span class="token" style="color:#d4d4d4">=</span><span> chat_engine</span><span class="token" style="color:#d4d4d4">.</span><span>stream_chat</span><span class="token" style="color:#d4d4d4">(</span><span>query</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">114</span><span>    </span><span class="token" style="color:#569CD6">for</span><span> res </span><span class="token" style="color:#569CD6">in</span><span> response</span><span class="token" style="color:#d4d4d4">.</span><span>response_gen</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">115</span><span>        </span><span class="token" style="color:#569CD6">yield</span><span> </span><span class="token string-interpolation" style="color:#ce9178">f&quot;data: {json.dumps({&quot;</span><span>message</span><span class="token" style="color:#ce9178">&quot;:res})}\n\n&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">116</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The above <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">load_rag()</em> function will first check if any previously stored index exists for re-using else it will build one. If no index is stored in the given <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">storage_path</em> directory, it will build the index by loading the documents from the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">docs_dir</em> directory. <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">SentenceWindowNodeParser</em> is used for parsing the sentences into nodes with a window size of 1. This window size makes the post-retrieval context have surrounding sentences also part of it for better answer synthesis. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">For created nodes, get the vector embeddings from the Cohere embeddings and store them in the Qdrant Cloud. And finally store the index for skipping this whole process again when the application restarts.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">From the index, build the chat engine with some memory (4096 tokens here) for memorizing past conversations with the user and provide Cohere Re-ranker as post node retrieval processer for reranking the nodes based on the query relevancy. This chat engine retrieves the surrounding context for each retrieved node for more information and finally sends the whole retrieved-context and the query to the LLM for answer generation as a prompt. I have used a custom prompt for making LLM answer as me.</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">/src/generate/constants.py</p></div><pre class="language-python:/src/generate/constants.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span>CHAT_PROMPT</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span>    </span><span class="token" style="color:#ce9178">&quot;You are impersonating the human &#x27;Lakshmi Narayana&#x27; and so your name.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span>    </span><span class="token" style="color:#ce9178">&quot;So you are Lakshmi Narayana and answers in first person.When asked any question about you, you will answer as if Lakshmi Narayana is answering.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span><span>    </span><span class="token" style="color:#ce9178">&quot;You will answer politely and take the help of the following context for more relevant answers.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span>    </span><span class="token" style="color:#ce9178">&quot;If you don&#x27;t have any sufficient information from the context, use your knowledge to answer.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span><span>    </span><span class="token" style="color:#ce9178">&quot;Or don&#x27;t hallucinate if you are sure you cannot answer.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span><span>    </span><span class="token" style="color:#ce9178">&quot;Here are the relevant documents for the context:\n{context_str}\n&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span>    </span><span class="token" style="color:#ce9178">&quot;Instruction: Use the previous chat history, or the context above, to interact and help the user and answer as if you are Lakshmi Narayana.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    </span><span class="token" style="color:#ce9178">&quot;Don&#x27;t add any additional data if the answer can be derived from context.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    </span><span class="token" style="color:#ce9178">&quot;Generate the response in markdown format.&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span></span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">LLamaindex uses this prompt for context ingestion and sends this to LLM for answer generation.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Finally, the chat generation API is exposed for streaming the response using FastAPI as follows</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">api.py</p></div><pre class="language-python:api.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1vh;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">1</span><span class="token" style="color:#569CD6">from</span><span> fastapi </span><span class="token" style="color:#569CD6">import</span><span> APIRouter</span><span class="token" style="color:#d4d4d4">,</span><span> HTTPException
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">2</span><span></span><span class="token" style="color:#569CD6">from</span><span> pydantic </span><span class="token" style="color:#569CD6">import</span><span> BaseModel
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">3</span><span></span><span class="token" style="color:#569CD6">from</span><span> starlette</span><span class="token" style="color:#d4d4d4">.</span><span>responses </span><span class="token" style="color:#569CD6">import</span><span> StreamingResponse
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">4</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">5</span><span></span><span class="token" style="color:#569CD6">from</span><span> </span><span class="token" style="color:#d4d4d4">.</span><span>rag </span><span class="token" style="color:#569CD6">import</span><span> chat
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">6</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">7</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">8</span><span></span><span class="token" style="color:#569CD6">class</span><span> </span><span class="token" style="color:#4ec9b0">GenerateModel</span><span class="token" style="color:#d4d4d4">(</span><span>BaseModel</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">9</span><span>    message</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">10</span><span>    message_id</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">11</span><span>    role</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">12</span><span>    timestamp</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">13</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">14</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">15</span><span>grouter </span><span class="token" style="color:#d4d4d4">=</span><span> APIRouter</span><span class="token" style="color:#d4d4d4">(</span><span>tags</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;generate&quot;</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">16</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">17</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">18</span><span></span><span class="token decorator annotation" style="color:#d4d4d4">@grouter</span><span class="token decorator annotation" style="color:#d4d4d4">.</span><span class="token decorator annotation" style="color:#d4d4d4">post</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">19</span><span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">generate</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">:</span><span> GenerateModel</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">20</span><span>    </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">21</span><span>        </span><span class="token" style="color:#569CD6">return</span><span> StreamingResponse</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">22</span><span>            chat</span><span class="token" style="color:#d4d4d4">(</span><span>data</span><span class="token" style="color:#d4d4d4">.</span><span>message</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">23</span><span>            media_type</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&#x27;text/event-stream&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">24</span><span>        </span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">25</span><span>    </span><span class="token" style="color:#569CD6">except</span><span> Exception </span><span class="token" style="color:#569CD6">as</span><span> e</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">26</span><span>        </span><span class="token" style="color:#569CD6">raise</span><span> HTTPException</span><span class="token" style="color:#d4d4d4">(</span><span>status_code</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">500</span><span class="token" style="color:#d4d4d4">,</span><span> detail</span><span class="token" style="color:#d4d4d4">=</span><span>e</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:3.25em;padding-right:1em;text-align:right;user-select:none;color:#6a9955">27</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">And final interactivity with LLM that answers about me like I am talking as </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/query-response-history.png" alt="LLM answering as me" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">LLM answering like me with history</span></span></picture></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">New Chat session</strong></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/doppalf-rag-powered-ai-chatbot/new-chat.gif" alt="New Chat Session" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">New Chat Session</span></span></picture></p><hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">I will some more features in the future like:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Adding or removing the documents dynamically from the UI</li><li>Voice cloning for speaking out the answer as a character</li><li>Enhance the LLM answering with more RAG strategies</li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Please check out the complete project code in my Github repository for <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://github.com/santhalakshminarayana/doppalf">Doppalf</a>.</p></article><div class="jsx-1393389675 footer-container"><div class="jsx-1393389675 footer-container-links"><div class="jsx-1393389675 footer-links"><div class="jsx-1393389675 link-item"><a href="https://github.com/santhalakshminarayana" rel="noreferrer" target=" _blank" class="jsx-1393389675 link"><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" style="color:#fffecb;font-size:calc(0.8rem + 1vw)" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></div></a></div><div class="jsx-1393389675 link-item"><a href="https://www.linkedin.com/in/santhalakshminarayana/" rel="noreferrer" target="_blank" class="jsx-1393389675 link"><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" style="color:#fffecb;font-size:calc(0.8rem + 1vw)" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></div></a></div><div class="jsx-1393389675 link-item"><a href="https://medium.com/@santhalakshminarayana/" rel="noreferrer" target="_blank" class="jsx-1393389675 link"><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" style="color:#fffecb;font-size:calc(0.8rem + 1vw)" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M13.54 12a6.8 6.8 0 01-6.77 6.82A6.8 6.8 0 010 12a6.8 6.8 0 016.77-6.82A6.8 6.8 0 0113.54 12zM20.96 12c0 3.54-1.51 6.42-3.38 6.42-1.87 0-3.39-2.88-3.39-6.42s1.52-6.42 3.39-6.42 3.38 2.88 3.38 6.42M24 12c0 3.17-.53 5.75-1.19 5.75-.66 0-1.19-2.58-1.19-5.75s.53-5.75 1.19-5.75C23.47 6.25 24 8.83 24 12z"></path></svg></div></a></div></div></div><div class="jsx-1393389675 copy-right-container"><p class="jsx-1393389675 copy-right-text">Santha Lakshmi Narayana © 2024</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postMetadata":{"title":"Doppalf: RAG powered full-stack AI chatbot like ChatGPT","description":"Build a full-stack RAG-powered AI chatbot like ChatGPT to give LLM your personality with Python, FastAPI, Llamaindex, Cohere, Qdrant, Next.js (Typescript), and Tailwind CSS.","imgName":"doppalf-rag-powered-ai-chatbot/doppalf-rag-powered-ai-chatbot.jpg","date":"May 24, 2024","tags":["python","ai","next-js","react"],"keywords":["python","llm","next-js","llamaindex","tailwind-css","typescript","fastapi","rag","cohere","qdrant","cohere-ai","ai-chatbot","llm","chatbot","chatgpt"],"id":"doppalf-rag-powered-ai-chatbot"},"postContent":{"compiledSource":"var m=Object.defineProperty,c=Object.defineProperties;var h=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;var p=(a,t,r)=\u003et in a?m(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,e=(a,t)=\u003e{for(var r in t||(t={}))i.call(t,r)\u0026\u0026p(a,r,t[r]);if(n)for(var r of n(t))s.call(t,r)\u0026\u0026p(a,r,t[r]);return a},l=(a,t)=\u003ec(a,h(t));var d=(a,t)=\u003e{var r={};for(var o in a)i.call(a,o)\u0026\u0026t.indexOf(o)\u003c0\u0026\u0026(r[o]=a[o]);if(a!=null\u0026\u0026n)for(var o of n(a))t.indexOf(o)\u003c0\u0026\u0026s.call(a,o)\u0026\u0026(r[o]=a[o]);return r};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(r){var o=r,{components:a}=o,t=d(o,[\"components\"]);return mdx(MDXLayout,l(e(e({},layoutProps),t),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/doppalf-rag-powered-ai-chatbot.jpg\",alt:\"Doppalf: RAG powered fullstack AI chatbot like ChatGPT\"}))),mdx(\"h6\",null,\"Published on: \",mdx(\"strong\",{parentName:\"h6\"},\"May 24, 2024\")),mdx(\"h1\",null,\"Doppalf: RAG-powered fullstack AI chatbot like ChatGPT\"),mdx(\"p\",null,\"I have built an end-to-end full-stack AI chatbot web application like ChatGPT. It's powered with RAG (Retrieval Augmentation Generation) to give LLM my personality. Meaning, that LLM will behave like me and assume the character of \",mdx(\"strong\",{parentName:\"p\"},\"Lakshmi Narayana\"),\". I have built this application with LLamaindex, Cohere AI, and the Qdrant database. The full tech stack is:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Docker\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Nginx\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"UI\"),\":\",mdx(\"ul\",{parentName:\"li\"},mdx(\"li\",{parentName:\"ul\"},\"Next.js (v14)\"),mdx(\"li\",{parentName:\"ul\"},\"Typescript\"),mdx(\"li\",{parentName:\"ul\"},\"Tailwind CSS\"))),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Backend\"),\":\",mdx(\"ul\",{parentName:\"li\"},mdx(\"li\",{parentName:\"ul\"},\"Python (v3.12)\"),mdx(\"li\",{parentName:\"ul\"},\"FastAPI\"),mdx(\"li\",{parentName:\"ul\"},\"Llamaindex\"),mdx(\"li\",{parentName:\"ul\"},\"Cohere AI\"),mdx(\"li\",{parentName:\"ul\"},\"Qdrant Cloud\")))),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/doppalf-response.gif\",alt:\"Doppalf AI:=:100:=:Doppalf AI streaming response\"}))),mdx(\"h2\",null,\"Architecture\"),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/doppalf-arch.png\",alt:\"Doppalf Architecture:=:100:=:Doppalf High level Architecture\"}))),mdx(\"blockquote\",null,mdx(\"p\",{parentName:\"blockquote\"},\"The whole project code can be found on GitHub for \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/santhalakshminarayana/doppalf\"}),\"Doppalf\"),\".\")),mdx(\"p\",null,\"For Doppalf, Docker has been used for container orchestration and Nginx as a reverse proxy. This application has a total three services (repos):\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"doppalf-rp (Nginx)\"),mdx(\"li\",{parentName:\"ul\"},\"doppalf-ui (Next.js)\"),mdx(\"li\",{parentName:\"ul\"},\"doppalf-ai (Python)\")),mdx(\"p\",null,\"Each of the above repos has an individual \",mdx(\"strong\",{parentName:\"p\"},\"Dockerfile\"),\" with optimized configuration. The following are the Dockerfiles for individual services:\"),mdx(\"h3\",null,\"doppalf-ui (Next.js)\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-yaml:Dockerfile\"}),`FROM node:21-bullseye-slim AS deps\nWORKDIR /app\nCOPY package*.json ./\nEXPOSE 3001\nENV PORT 3001\nENV HOSTNAME \"0.0.0.0\"\nRUN npm ci\n\n# Development\nFrom deps as dev\nENV NODE_ENV=development\nCOPY . .\nCMD [\"npm\", \"run\", \"dev\"]\n\nFROM node:21-bullseye-slim AS builder\nWORKDIR /app\nCOPY --from=deps /app/node_modules ./node_modules\nCOPY . .\nRUN npm run build\nRUN npm prune --production\n\n# Production\nFROM node:21-bullseye-slim AS prod\nWORKDIR /app\nENV NODE_ENV production\n# Add nextjs user\nRUN addgroup --system --gid 1001 nodejs\nRUN adduser --system --uid 1001 nextjs\n# Set the permission for prerender cache\nRUN mkdir .next\nRUN chown nextjs:nodejs .next\nUSER nextjs\n# Automatically leverage output traces to reduce image size\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static\nCOPY --from=builder --chown=nextjs:nodejs /app/public ./public\n\nEXPOSE 3001\nENV PORT 3001\nENV HOSTNAME \"0.0.0.0\"\n\nCMD [\"npm\", \"start\"]\n`)),mdx(\"p\",null,\"The above \",mdx(\"strong\",{parentName:\"p\"},\"Dockerfile\"),\" has a multi-stage build config for both \",mdx(\"em\",{parentName:\"p\"},\"dev\"),\" and \",mdx(\"em\",{parentName:\"p\"},\"prod\"),\" environments. The exact build stage to be used will be determined by configuration from \",mdx(\"em\",{parentName:\"p\"},\"docker-compose.yaml\"),\". By default, the \",mdx(\"em\",{parentName:\"p\"},\"dev\"),\" stage is used. The above configuration for \",mdx(\"em\",{parentName:\"p\"},\"prod\"),\" is very optimal and reduces the final running docker image size due to Next.js optimizations.\"),mdx(\"h3\",null,\"doppalf-ai (Python)\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-yaml:Dockerfile\"}),`# Why bookworm? https://pythonspeed.com/articles/base-image-python-docker-images/\nFROM python:3.12-slim-bookworm as base\nWORKDIR /app\nRUN apt-get update \u0026\u0026 \\\\\n    apt-get install -y --no-install-recommends gcc\nCOPY requirements.txt .\nRUN pip wheel --no-cache-dir --no-deps --wheel-dir /app/wheels -r requirements.txt\n\nFROM python:3.12-slim-bookworm as build\nENV PYTHONDONTWRITEBYTECODE=1\nENV PYTHONUNBUFFERED=1\nWORKDIR /app\nCOPY --from=base /app/wheels /app/wheels\nCOPY --from=base /app/requirements.txt .\nRUN pip install --no-cache /app/wheels/*\nCOPY . /app\nEXPOSE 4001\nCMD [\"python\", \"main.py\"]\n`)),mdx(\"p\",null,\"The above \",mdx(\"strong\",{parentName:\"p\"},\"Dockerfile\"),\" pulls Python 3.12 \",mdx(\"em\",{parentName:\"p\"},\"slim-bookworm\"),\" docker image as opposed to the common \",mdx(\"em\",{parentName:\"p\"},\"alpine\"),\" image. You can refer to the linked article for why. Here instead of normally installing requirements through \",mdx(\"em\",{parentName:\"p\"},\"pip\"),\", we install dependencies through \",mdx(\"em\",{parentName:\"p\"},\"wheels\"),\" which optimizes the docker image build speed.\"),mdx(\"p\",null,\"The Next.js service will be running on PORT \",mdx(\"em\",{parentName:\"p\"},\"3001\"),\" and the Python service will run on \",mdx(\"em\",{parentName:\"p\"},\"4001\"),\".\"),mdx(\"h3\",null,\"doppalf-rp (Nginx)\"),mdx(\"p\",null,\"And finally, Nginx configuration for forwarding the traffic to individual services are done as \"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-:includes/proxy.conf\"}),`proxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\nproxy_set_header X-Forwarded-Host $server_name;\nproxy_buffering off;\nproxy_request_buffering off;\nproxy_http_version 1.1;\nproxy_intercept_errors on;\n`)),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-yaml:Dockerfile\"}),`From nginx:stable-alpine\nRUN mkdir -p /run/nginx\nWORKDIR /run/nginx\nCOPY ./nginx.conf /etc/nginx/conf.d/default.conf\nCOPY ./includes /etc/nginx/includes/\nEXPOSE 80\nCMD [\"nginx\", \"-g\", \"daemon off;\"]\n`)),mdx(\"p\",null,\"Nginx configruation for forwarding rules for different services\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-:nginx.conf\"}),`server {\n    listen 80 default_server;\n    listen [::]:80 default_server;\n    server_name _;\n\n    index index.html;\n\n    location / {\n        proxy_pass http://doppalf-ui-service:3001;\n    }\n\n    location /doppalf-ai/v1 {\n        proxy_pass http://doppalf-ai-service:4001;\n\n        proxy_redirect off;\n        # SSE connection config\n        proxy_set_header Connection '';\n        proxy_cache off;\n    }\n}\n`)),mdx(\"p\",null,\"So, the root \",mdx(\"em\",{parentName:\"p\"},\"/\"),\" request (127.0.0.1) will be forwarded to the Next.js UI service for the UI page, and any request with the prefix \",mdx(\"em\",{parentName:\"p\"},\"/doppalf-ai/v1\"),\" will be forwarded to the Python AI service.\"),mdx(\"h2\",null,\"Doppalf UI\"),mdx(\"p\",null,\"The UI has been built with Next.js (Typescript) and Tailwind CSS. It's a single-page application that mainly contains an input box for providing Query and the response will be generated like ChatGPT where the UI will show the user and system messages. The AI-generated answer will be streamed like ChatGPT and rendered as Markdown. This has been done by Streaming the text from the Backend as \",mdx(\"strong\",{parentName:\"p\"},\"SSE (Server Sent Events)\"),\" and reading those messages in Next.js using using Microsoft's \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://www.npmjs.com/package/@microsoft/fetch-event-source\"}),\"Fetch Event Source package\"),\" because normal browser SSE doesn't support \",mdx(\"em\",{parentName:\"p\"},\"POST\"),\" request.\"),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/doppalf-ui-query-response.png\",alt:\"Doppalf UI Landing Page:=:100:=:Showing User and System Message\"}))),mdx(\"h4\",null,\"UI Features include:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Dark mode\"),mdx(\"li\",{parentName:\"ul\"},\"Streaming responses like ChatGPT\"),mdx(\"li\",{parentName:\"ul\"},\"Auto-scroll to the bottom while generating the answer\"),mdx(\"li\",{parentName:\"ul\"},\"New chat session\")),mdx(\"h2\",null,\"Doppalf AI\"),mdx(\"p\",null,\"The main part of this application is building the RAG pipeline and giving LLM a personal character that answers like me. For this, I have used Llamaindex for building the RAG pipeline, Cohere AI as LLM, and Qdrant Cloud for storing vector embeddings.\"),mdx(\"p\",null,\"This costs me nothing as they both offer free APIs, you can get free \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://dashboard.cohere.com/api-keys\"}),\"Cohere API trail Key\"),\" and 1 GB cluster for storing vectors in \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://cloud.qdrant.io\"}),\"Qdrant Cloud API Key and URL\"),\".\"),mdx(\"p\",null,\"The web framework for providing APIs used was FastAPI and its support for streaming the response like SSE without using any extra configuration was a huge thumbs up for this kind of AI Chatbot application.\"),mdx(\"p\",null,\"For building the RAG pipeline, I have followed the following pipeline process:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Load Documents\"),mdx(\"li\",{parentName:\"ul\"},\"Parse text into Sentences (as nodes) with Window size as 1\"),mdx(\"li\",{parentName:\"ul\"},\"Get vector embeddings for each node (sentences) with Cohere Embeddings\"),mdx(\"li\",{parentName:\"ul\"},\"Index the nodes and store the vector embeddings in the Qdrant cloud\"),mdx(\"li\",{parentName:\"ul\"},\"Persist the index for re-use further runtimes\"),mdx(\"li\",{parentName:\"ul\"},'Build a Chat engine from the index with a retrieval strategy as \"Small-to-Big\" and with some buffered chat memory history'),mdx(\"li\",{parentName:\"ul\"},\"Provide the retrieved context and use Cohere Rerank for reranking the retrieved nodes\"),mdx(\"li\",{parentName:\"ul\"},\"Synthesis the response using Cohere\")),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/rag-pipeline.jpg\",alt:\"RAG Pipeline:=:100:=:RAG pipeline\"}))),mdx(\"p\",null,\"The complete code for the RAG pipeline using Llamaindex is \"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-python:rag.py\"}),`from llama_index.core import load_index_from_storage\nfrom llama_index.core.memory import ChatMemoryBuffer\nfrom llama_index.core.node_parser import SentenceWindowNodeParser\nfrom llama_index.core.postprocessor import MetadataReplacementPostProcessor\nfrom llama_index.embeddings.cohere import CohereEmbedding\nfrom llama_index.llms.cohere import Cohere\nfrom llama_index.postprocessor.cohere_rerank import CohereRerank\nfrom llama_index.vector_stores.qdrant import QdrantVectorStore\nfrom qdrant_client import QdrantClient\n\nfrom src.config.env import ENV, env_keys\nfrom src.config.logger import get_logger\n\nfrom .constants import CHAT_PROMPT\n\nenvk = ENV()\nlogger = get_logger()\n\nindex = None\nchat_engine = None\n\ndef load_rag() -\u003e None:\n    global index\n    global chat_engine\n\n    cdir = os.getcwd()\n    docs_dir = envk.get(env_keys.get(\"DOCS_DIR\"))\n    docs_path = os.path.join(cdir, docs_dir)\n\n    # check if any documents are provided for index\n    if not os.path.exists(docs_path):\n        raise FileNotFoundError(f\"Documents dir at path: {docs_path} not exists.\")\n    if not os.listdir(docs_dir):\n        raise FileNotFoundError(f\"Provide documents inside directory: {docs_path} for indexing.\")\n    \n    storage_dir = envk.get(env_keys.get(\"INDEX_STORAGE_DIR\"))\n    storage_path = os.path.join(cdir, storage_dir)\n    \n    cohere_api_key = envk.get(env_keys.get(\"COHERE_API_KEY\"))\n    qdrant_api_key = envk.get(env_keys.get(\"QDRANT_API_KEY\"))\n\n    Settings.llm = Cohere(\n        api_key=cohere_api_key,\n        model=\"command-r-plus\", \n    )\n    Settings.embed_model = CohereEmbedding(\n        cohere_api_key=cohere_api_key,\n        model_name=\"embed-english-v3.0\",\n        input_type=\"search_document\",\n    )\n    \n    qd_client = QdrantClient(\n        envk.get(env_keys.get(\"QDRANT_CLOUD_URL\")),\n        api_key=qdrant_api_key,\n    )\n\n    sentence_node_parser = SentenceWindowNodeParser.from_defaults(\n        window_size=1,\n        window_metadata_key=\"window\",\n        original_text_metadata_key=\"original_text\", \n    )\n\n    vector_store = QdrantVectorStore(\n        client=qd_client, \n        collection_name=envk.get(env_keys.get(\"COLLECTION_NAME\")),\n    )\n\n    # index was previously persisted\n    if os.path.exists(storage_path) and os.listdir(storage_path):\n        logger.debug(\"Using existing index.\")\n        storage_context = StorageContext.from_defaults(\n            vector_store=vector_store, persist_dir=storage_path\n        )\n        \n        index = load_index_from_storage(storage_context)\n\n    else:\n        logger.debug(\"Creating new index for documents.\")\n        reader = SimpleDirectoryReader(input_dir=docs_path)\n        \n        all_docs = []\n        for docs in reader.iter_data():\n            all_docs.extend(docs)\n        \n        for doc in all_docs:\n            logger.debug(f\"id: {doc.doc_id}\\\\nmetada: {doc.metadata}\")\n\n        nodes = sentence_node_parser.get_nodes_from_documents(all_docs)\n        \n        storage_context = StorageContext.from_defaults(vector_store=vector_store)\n        \n        index = VectorStoreIndex(nodes, storage_context=storage_context)\n\n        index.storage_context.persist(persist_dir=storage_path)\n\n\n    chat_engine = index.as_chat_engine(\n        chat_mode=\"condense_plus_context\",\n        memory=ChatMemoryBuffer.from_defaults(token_limit=int(envk.get(env_keys.get(\"MAX_BUFFER_MEMORY_TOKENS\")))),\n        context_prompt=CHAT_PROMPT,\n        similarity_top_k=3, \n        node_postprocessors=[\n            MetadataReplacementPostProcessor(target_metadata_key=\"window\"),\n            CohereRerank(api_key=cohere_api_key, top_n=3),\n        ],\n        verbose=False,\n    )\n\n\ndef chat(query: str):\n    global chat_engine\n    \n    response = chat_engine.stream_chat(query)\n    for res in response.response_gen:\n        yield f\"data: {json.dumps({\"message\":res})}\\\\n\\\\n\"\n`)),mdx(\"p\",null,\"The above \",mdx(\"em\",{parentName:\"p\"},\"load_rag()\"),\" function will first check if any previously stored index exists for re-using else it will build one. If no index is stored in the given \",mdx(\"em\",{parentName:\"p\"},\"storage_path\"),\" directory, it will build the index by loading the documents from the \",mdx(\"em\",{parentName:\"p\"},\"docs_dir\"),\" directory. \",mdx(\"em\",{parentName:\"p\"},\"SentenceWindowNodeParser\"),\" is used for parsing the sentences into nodes with a window size of 1. This window size makes the post-retrieval context have surrounding sentences also part of it for better answer synthesis. \"),mdx(\"p\",null,\"For created nodes, get the vector embeddings from the Cohere embeddings and store them in the Qdrant Cloud. And finally store the index for skipping this whole process again when the application restarts.\"),mdx(\"p\",null,\"From the index, build the chat engine with some memory (4096 tokens here) for memorizing past conversations with the user and provide Cohere Re-ranker as post node retrieval processer for reranking the nodes based on the query relevancy. This chat engine retrieves the surrounding context for each retrieved node for more information and finally sends the whole retrieved-context and the query to the LLM for answer generation as a prompt. I have used a custom prompt for making LLM answer as me.\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-python:/src/generate/constants.py\"}),`CHAT_PROMPT=(\n    \"You are impersonating the human 'Lakshmi Narayana' and so your name.\"\n    \"So you are Lakshmi Narayana and answers in first person.When asked any question about you, you will answer as if Lakshmi Narayana is answering.\"\n    \"You will answer politely and take the help of the following context for more relevant answers.\"\n    \"If you don't have any sufficient information from the context, use your knowledge to answer.\"\n    \"Or don't hallucinate if you are sure you cannot answer.\"\n    \"Here are the relevant documents for the context:\\\\n{context_str}\\\\n\"\n    \"Instruction: Use the previous chat history, or the context above, to interact and help the user and answer as if you are Lakshmi Narayana.\"\n    \"Don't add any additional data if the answer can be derived from context.\"\n    \"Generate the response in markdown format.\"\n)\n`)),mdx(\"p\",null,\"LLamaindex uses this prompt for context ingestion and sends this to LLM for answer generation.\"),mdx(\"p\",null,\"Finally, the chat generation API is exposed for streaming the response using FastAPI as follows\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"language-python:api.py\"}),`from fastapi import APIRouter, HTTPException\nfrom pydantic import BaseModel\nfrom starlette.responses import StreamingResponse\n\nfrom .rag import chat\n\n\nclass GenerateModel(BaseModel):\n    message: str\n    message_id: str\n    role: str\n    timestamp: str\n\n\ngrouter = APIRouter(tags=[\"generate\"])\n\n\n@grouter.post(\"\")\nasync def generate(data: GenerateModel):\n    try:\n        return StreamingResponse(\n            chat(data.message), \n            media_type='text/event-stream',\n        )\n    except Exception as e:\n        raise HTTPException(status_code=500, detail=e)\n`)),mdx(\"p\",null,\"And final interactivity with LLM that answers about me like I am talking as \"),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/query-response-history.png\",alt:\"LLM answering as me:=:100:=:LLM answering like me with history\"}))),mdx(\"p\",null,mdx(\"strong\",{parentName:\"p\"},\"New Chat session\")),mdx(\"p\",null,mdx(\"img\",e({parentName:\"p\"},{src:\"doppalf-rag-powered-ai-chatbot/new-chat.gif\",alt:\"New Chat Session:=:100:=:New Chat Session\"}))),mdx(\"hr\",null),mdx(\"p\",null,\"I will some more features in the future like:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Adding or removing the documents dynamically from the UI\"),mdx(\"li\",{parentName:\"ul\"},\"Voice cloning for speaking out the answer as a character\"),mdx(\"li\",{parentName:\"ul\"},\"Enhance the LLM answering with more RAG strategies\")),mdx(\"p\",null,\"Please check out the complete project code in my Github repository for \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/santhalakshminarayana/doppalf\"}),\"Doppalf\"),\".\"))}MDXContent.isMDXComponent=!0;\n","scope":{}},"id":"doppalf-rag-powered-ai-chatbot"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"doppalf-rag-powered-ai-chatbot"},"buildId":"XrdYHN_JN9xv8GJ3wA13S","runtimeConfig":{},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>