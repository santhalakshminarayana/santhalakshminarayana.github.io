<!DOCTYPE html><html lang="en"><head><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="stylesheet" data-href="https://fonts.googleapis.com/css2?family=Maven+Pro&amp;family=Share+Tech+Mono&amp;family=Source+Sans+Pro&amp;family=Ubuntu&amp;display=swap" data-optimized-fonts="true"/><meta charSet="utf-8" class="jsx-1085971570"/><meta name="viewport" content="width=device-width, initial-scale=1" class="jsx-1085971570"/><meta name="description" content="Effective implementation of asynchronous or concurrency patterns like Background task and Worker Pool in Python using Asyncio." class="jsx-1085971570"/><meta name="author" content="Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="keywords" content="concurrency,asyncio,python-concurrency,worker-pool,job-queue,worker-queue,background-thread,background-task,background-job,python-performance,python-optimize,python,fast-python,speed" class="jsx-1085971570"/><meta property="og:title" content="Asynchronous or Concurrency patterns in Python with Asyncio- Santha Lakshmi Narayana" class="jsx-1085971570"/><meta property="og:description" content="Effective implementation of asynchronous or concurrency patterns like Background task and Worker Pool in Python using Asyncio." class="jsx-1085971570"/><meta property="og:url" content="https://santhalakshminarayana.github.io/blog/concurrency-patterns-python" class="jsx-1085971570"/><meta property="og:image" content="https://santhalakshminarayana.github.io/images/concurrency-patterns-python/concurrency-patterns-python.jpg" class="jsx-1085971570"/><meta property="og:type" content="article" class="jsx-1085971570"/><meta property="og:article:publisher" content="https://santhalakshminarayana.github.io/" class="jsx-1085971570"/><meta property="og:site_name" content="Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="twitter:card" content="summary_large_image" class="jsx-1085971570"/><meta name="twitter:title" content="Asynchronous or Concurrency patterns in Python with Asyncio- Santha Lakshmi Narayana" class="jsx-1085971570"/><meta name="twitter:description" content="Effective implementation of asynchronous or concurrency patterns like Background task and Worker Pool in Python using Asyncio." class="jsx-1085971570"/><meta name="twitter:url" content="https://santhalakshminarayana.github.io/blog/concurrency-patterns-python" class="jsx-1085971570"/><meta name="twitter:site" content="@santhalakshminarayana" class="jsx-1085971570"/><meta name="twitter:image" content="https://santhalakshminarayana.github.io/images/concurrency-patterns-python/concurrency-patterns-python.jpg" class="jsx-1085971570"/><meta name="twitter:creator" content="@santhalakshminarayana" class="jsx-1085971570"/><link rel="icon" href="/images/santha-lakshmi-narayana-logo.png?" class="jsx-1085971570"/><link rel="canonical" href="https://santhalakshminarayana.github.io/blog/concurrency-patterns-python" class="jsx-1085971570"/><title class="jsx-1085971570">Asynchronous or Concurrency patterns in Python with Asyncio- Santha Lakshmi Narayana</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" crossorigin="anonymous" class="jsx-1085971570"/><meta name="next-head-count" content="24"/><link rel="preload" href="/_next/static/css/b1be9be44572118d40d2.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b1be9be44572118d40d2.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-2b6f4fb4c650415a78b4.js" defer=""></script><script src="/_next/static/chunks/framework.1b3b121feae4c8ce410b.js" defer=""></script><script src="/_next/static/chunks/commons.5b2d72a8e34e4f7cda46.js" defer=""></script><script src="/_next/static/chunks/main-68d5ee93b85f98054dc7.js" defer=""></script><script src="/_next/static/chunks/pages/_app-20e9ec4927e85f5bde92.js" defer=""></script><script src="/_next/static/chunks/d0447323.502fa6f1a0e18a7c65ff.js" defer=""></script><script src="/_next/static/chunks/773f402080c38a523cb0b4f52dac49b5097e45fc.b17877e2e5da2299c107.js" defer=""></script><script src="/_next/static/chunks/6188d020c9511bd1e7ae4c1c2034aa4e99a1704e.075cc36b135655684098.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5Bid%5D-6d72722fdc5d7667b357.js" defer=""></script><script src="/_next/static/XKjk8v4y5tDLQXnU9TJA9/_buildManifest.js" defer=""></script><script src="/_next/static/XKjk8v4y5tDLQXnU9TJA9/_ssgManifest.js" defer=""></script><style id="__jsx-3242260268">.tags.jsx-3242260268{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;padding:1vw 5vw 1vw 5vw;background-color:#fffecb;border-bottom:5px solid #071013;}.tags.jsx-3242260268 a.jsx-3242260268{font-family:"Share Tech Mono",monospace;color:#1d2b35;margin:0 1em 0 1em;-webkit-text-decoration:none;text-decoration:none;border-bottom:1px dashed #fb232e;}.tags.jsx-3242260268 a.jsx-3242260268:hover{background:#20a4f3;color:#fffecb;border-bottom:1px dashed #fffecb;}.tags.jsx-3242260268 a.jsx-3242260268:active{background:#fb232e;}</style><style id="__jsx-1327536233">.header-container.jsx-1327536233{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:10px 5vw 10px 5vw;background:#1d2b35;}.header-left.jsx-1327536233{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.header-left.jsx-1327536233 a.jsx-1327536233{font-family:"Source Sans Pro",sans-serif;-webkit-text-decoration:none;text-decoration:none;color:#ffaa33;}img.jsx-1327536233{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;width:calc(1.2rem + 1vw);max-width:calc(1.2rem + 1vw);height:auto;margin:0 5px 0 5px;}img.jsx-1327536233:hover{cursor:pointer;}.header-left.jsx-1327536233 a.jsx-1327536233:hover{color:#20a4f3;}.header-left.jsx-1327536233 a.jsx-1327536233:active{color:#fb232e;}.header-right.jsx-1327536233{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:3;-ms-flex:3;flex:3;-webkit-flex-direction:row-reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.header-right.jsx-1327536233 a.jsx-1327536233{padding:0 1vw 0 1vw;font-family:"Source Sans Pro",sans-serif;-webkit-text-decoration:none;text-decoration:none;color:#ffaa33;}.header-right.jsx-1327536233 a.jsx-1327536233:hover{color:#20a4f3;}.header-right.jsx-1327536233 a.jsx-1327536233:active{color:#fb232e;}@media screen and (max-width:920px){.header-container.jsx-1327536233{padding:10px 2vw 10px 2vw;overflow-x:scroll;}#name.jsx-1327536233{display:none;}img.jsx-1327536233{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media screen and (max-width:480px){.header-container.jsx-1327536233{padding:10px 2vw 10px 2vw;overflow-x:scroll;}}@media screen and (max-width:300px){img.jsx-1327536233{display:none;}}</style><style id="__jsx-2944168904">.img-text.jsx-2944168904{display:block;text-align:center;font-family:"Source Sans Pro",sans-serif;font-size:calc(0.8rem + 0.1vw);color:#1d2b35;overflow-wrap:"break-word";}a.jsx-2944168904{margin:0;-webkit-text-decoration:none;text-decoration:none;color:#1d2b35;border-bottom:1px solid;}</style><style id="__jsx-1110062031">.file-name-container.jsx-1110062031{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;width:100%;max-width:100%;background-color:#1d2b35d9;padding:calc(0.5rem + 0.2vw);border-top-left-radius:5px;border-top-right-radius:5px;margin-top:1vh;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;}.file-name.jsx-1110062031{font-family:"Share Tech Mono",monospace;font-size:calc(0.9rem + 0.1vw);color:#fffecbf2;}</style><style id="__jsx-1393389675">.footer-container.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;background:#1d2b35e6;padding:1vw 1vw 1vw 1vw;}.footer-container-links.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}.footer-links.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.link-item.jsx-1393389675{margin:0 1vw 0 1vw;}.link.jsx-1393389675{-webkit-text-decoration:none;text-decoration:none;cursor:pointer: background-color:yellow;}.link.jsx-1393389675:hover{color:black;}.copy-right-container.jsx-1393389675{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-top:10px;}.copy-right-text.jsx-1393389675{font-family:'Maven Pro',sans-serif;font-size:calc(0.75rem + 0.1vw);color:#fffecb;}</style><style id="__jsx-1085971570">.blog-content.jsx-1085971570{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:100%;-ms-flex:100%;flex:100%;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:1vw 25vw 1vw 25vw;width:50vw;max-width:50vw;min-height:90vh;}@media screen and (max-width:980px){.blog-content.jsx-1085971570{margin:1vw 15vw 1vw 15vw;width:70vw;max-width:70vw;}}@media screen and (max-width:760px){.blog-content.jsx-1085971570{margin:1vw 5vw 1vw 5vw;width:90vw;max-width:90vw;}}</style><style data-href="https://fonts.googleapis.com/css2?family=Maven+Pro&family=Share+Tech+Mono&family=Source+Sans+Pro&family=Ubuntu&display=swap">@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX25nM&skey=f795ffecfc1ee92e&v=v33) format('woff')}@font-face{font-family:'Share Tech Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=J7aHnp1uDWRBEqV98dVQztYldFc7pw&skey=241741910c57ea83&v=v15) format('woff')}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=6xK3dSBYKcSV-LCoeQqfX1RYOo3aPA&skey=1e026b1c27170b9b&v=v22) format('woff')}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=4iCs6KVjbNBYlgo6ew&skey=7e59fc036a1a8481&v=v20) format('woff')}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nijpBh8CvRBOB1s&skey=f795ffecfc1ee92e&v=v33) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nmjpBh8CvRBOB1s&skey=f795ffecfc1ee92e&v=v33) format('woff');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Maven Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/l/font?kit=7Auup_AqnyWWAxW2Wk3swUz56MS91Eww8SX21nejpBh8CvRBOA&skey=f795ffecfc1ee92e&v=v33) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Share Tech Mono';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sharetechmono/v15/J7aHnp1uDWRBEqV98dVQztYldFcLowEFA87Heg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNa7lujVj9_mf.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qPK7lujVj9_mf.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNK7lujVj9_mf.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qO67lujVj9_mf.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qN67lujVj9_mf.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qNq7lujVj9_mf.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Source Sans Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7lujVj9w.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcg72nU6AF7xm.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKew72nU6AF7xm.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcw72nU6AF7xm.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKfA72nU6AF7xm.woff2) format('woff2');unicode-range:U+0370-0377,U+037A-037F,U+0384-038A,U+038C,U+038E-03A1,U+03A3-03FF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKcQ72nU6AF7xm.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20C0,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Ubuntu';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/ubuntu/v20/4iCs6KVjbNBYlgoKfw72nU6AFw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><div style="min-height:100vh" class="jsx-1085971570"><div class="jsx-1327536233 header"><div class="jsx-1327536233 header-container"><div class="jsx-1327536233 header-left"><img src="/images/santha-lakshmi-narayana-logo.png" alt="Logo" class="jsx-1327536233"/><a id="name" class="jsx-1327536233" href="/"><b class="jsx-1327536233">Santha Lakshmi Narayana</b></a></div><div class="jsx-1327536233 header-right"><a class="jsx-1327536233" href="/about">About</a><a href="#" class="jsx-1327536233">Tags</a><a class="jsx-1327536233" href="/">Home</a></div></div><div style="display:none" class="jsx-1327536233"><div class="jsx-3242260268 tags"><a class="jsx-3242260268" href="/tags/python">#python</a><a class="jsx-3242260268" href="/tags/go">#go</a><a class="jsx-3242260268" href="/tags/image-processing">#image-processing</a><a class="jsx-3242260268" href="/tags/opencv">#opencv</a><a class="jsx-3242260268" href="/tags/concurrency">#concurrency</a><a class="jsx-3242260268" href="/tags/python-performance">#python-performance</a><a class="jsx-3242260268" href="/tags/color-science">#color-science</a><a class="jsx-3242260268" href="/tags/react">#react</a><a class="jsx-3242260268" href="/tags/next-js">#next-js</a><a class="jsx-3242260268" href="/tags/flutter">#flutter</a></div></div></div><article class="jsx-1085971570 blog-content"><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/concurrency-patterns-python/concurrency-patterns-python.jpg" alt="Asynchronous or Concurrency Patterns in Python" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"></span></picture></p><h6 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#fb232e;margin:1vh 0 1vh 0;overflow-wrap:break-word">Published on: <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Mar 6, 2024</strong></h6><h1 style="font-family:&#x27;Ubuntu&#x27;, sans-serif;font-size:calc(1rem + 1.5vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Asynchronous or Concurrency Patterns in Python with Asyncio</h1><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Most software development tasks require an asynchronous way of handling things like running background tasks, processing multiple tasks at a time, applying the same operations on huge data, distributing tasks to free workers, etc. In this blog, we will see how can we achieve some of these patterns with Python. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Before delving into the concept, the most important thing we need to understand is <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">concurrency vs parallelism</em>. Concurrency is about handling multiple tasks at a time and this handling might be in parallel or not. Whereas parallelism is about doing multiple tasks parallelly/simultaneously at a time. Parallelism can be termed as concurrency but not vice-versa. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In my earlier blog posts about <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing">Super Fast Python: Multiprocessing</a>, I have described how can achieve parallelism with Python.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">One can ask, in parallelism, if we can do multiple things at a time, why do we need to focus on concurrency at all? The answer to this question simply depends on the program language in the discussion. Some program languages like C/C++ are built to directly use multiple cores/vCPUs of the host machine for parallelism, while other languages like Golang can still utilize multiple cores but with concurrency, not parallel. Both of these types of languages can do both concurrency and parallelism very smoothly. But we have a special child like Python, whose creators put so many restrictions (which are thoughtful at creation) to be a better resource utiliser. GIL in Python makes the Python interpreter run only one thread at a time and cannot multiplex the multiple threads to multiple cores. I have already discussed this in my previous post about <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow">Why Python is Slow</a>.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">To utilize multiple cores, we have to create at least one process per core. The creation and memory management of the process is time-consuming and comes with its overheads. So, a general rule of thumb is to use multi-programming for CPU-intensive tasks, and I/O bound tasks like network calls, and reading from disk are handled concurrently with threads. As we can use multi-threading in Python, creating and managing a huge number of threads is not optimal in Python or any high-level language. The solution to create and manage huge numbers of thread-like objects say in thousands or 100s of thousands, we can use Co-routines which can be termed as virtual threads or small threads whose memory footprint is very minimal compared to threads. And we can spawn thousands of these in a few microseconds.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Coroutines are part of core Python and are handled with an in-built package called <a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://docs.python.org/3/library/asyncio.html">asyncio</a></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The goal of this article is to demonstrate some concurrency patterns rather than learning about coroutines. So, it&#x27;s expected to have some basic background with <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">asyncio</em>.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the following sections, we cover the two most used concurrency patterns:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Background tasks with Ticker</li><li>WorkerPool pattern</li><li>Pipeline or Chain processing</li></ul><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Ticker &amp; Background tasks</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Let&#x27;s say we have a stream of data coming and stored in some data sources like Database, Redis, or in the Cloud. And we want to analyze that data periodically let&#x27;s say every 1 day and send an email notification to the customers with the analyzed report. This is a basic CRON job that we execute in Linux. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If you don&#x27;t know what the is ticker, it is a kind of background task where the program will be notified for every time interval that we need to do some task. Tickers are all over any periodic notification or job updates. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">We will use a ticker for our coroutine to come into the foreground and call a callback that it receives with callback arguments. Let&#x27;s look at the following ticker class</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">ticker.py</p></div><pre class="language-python:ticker.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">from</span><span> threading </span><span class="token" style="color:#569CD6">import</span><span> Event</span><span class="token" style="color:#d4d4d4">,</span><span> Thread
</span><span></span><span class="token" style="color:#569CD6">from</span><span> typing </span><span class="token" style="color:#569CD6">import</span><span> Any</span><span class="token" style="color:#d4d4d4">,</span><span> Callable</span><span class="token" style="color:#d4d4d4">,</span><span> Optional
</span>
<span></span><span class="token" style="color:#569CD6">class</span><span> </span><span class="token" style="color:#4ec9b0">Ticker</span><span class="token" style="color:#d4d4d4">(</span><span>Thread</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">__init__</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        is_daemon</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        tick_period</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        callback</span><span class="token" style="color:#d4d4d4">:</span><span> Callable</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        </span><span class="token" style="color:#d4d4d4">**</span><span>cbkwargs</span><span class="token" style="color:#d4d4d4">:</span><span> Optional</span><span class="token" style="color:#d4d4d4">[</span><span>Any</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        Thread</span><span class="token" style="color:#d4d4d4">.</span><span>__init__</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>daemon </span><span class="token" style="color:#d4d4d4">=</span><span> is_daemon
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>tick_period </span><span class="token" style="color:#d4d4d4">=</span><span> tick_period
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>task_kill_event </span><span class="token" style="color:#d4d4d4">=</span><span> Event</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>callback </span><span class="token" style="color:#d4d4d4">=</span><span> callback
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>cbkwargs </span><span class="token" style="color:#d4d4d4">=</span><span> cbkwargs
</span>
<span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">kill</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>task_kill_event</span><span class="token" style="color:#d4d4d4">.</span><span class="token" style="color:#ce9178">set</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">while</span><span> </span><span class="token" style="color:#569cd6">True</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            is_killed </span><span class="token" style="color:#d4d4d4">=</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>task_kill_event</span><span class="token" style="color:#d4d4d4">.</span><span>wait</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>tick_period</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">if</span><span> is_killed</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Exiting ticker.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">break</span><span>
</span>
<span>            </span><span class="token" style="color:#6a9955"># call the callback</span><span>
</span><span>            self</span><span class="token" style="color:#d4d4d4">.</span><span>callback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">**</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>cbkwargs</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This class inherits the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">Thread</em> class to implement custom thread functionality. In the constructor, we pass the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">is_daemon</em> flag that makes the current thread run as a daemon or not. Usually for background tasks that do not stick to the application lifecycle, they are not meant to be daemon. And other params like <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">tick_period</em> which says the time interval for the ticker, <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">callback</em> is a callback function, and <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">cbkwargs</em> are callback key arguments to pass to this callback function. We will speak about <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">self.task_kill_event = Event()</em> later.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This class has two methods <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">kill</em> and <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">run</em> where <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">run</em> is an overridden <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">Thread</em> class function. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://docs.python.org/3/library/threading.html#event-objects"><em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">threading.Event()</em></a> object is used for communication between threads. It&#x27;s simply a boolean flag that one thread signals the other thread that listens to this event object states. We use an event object to signal for the background task to exit. This is what the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">kill</em> function is. If we call this function, it will set the event to be <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">True</strong> signaling the listing thread.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The overriding <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">run</em> method is a classic implementation of a background running thread, it will run in a loop until it receives the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">is_killed</em> to be <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">True</strong> which we set by calling <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">kill</em>. <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">self.task_kill_event.wait(self.tick_period)</em> is where the magic happens. Here we will wait for the specified ticker period for that event to be set. After the specified interval period, if we don&#x27;t receive the event signal, the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">is_killed</strong> will be False, and we will call the callback with the keyword arguments.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Why don&#x27;t we use a simple <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">thread.sleep</em> for sleeping in the background? Let&#x27;s say, that while waiting for a ticker period, we get the event signal, then we have to right away exit the thread. For example, if the ticker period is for 10 seconds, and while in the 6th second, we get the signal, we will exit there instead of waiting for the other 4 seconds. This can&#x27;t be achieved with thread sleep. This is very useful if we are running larger ticker periods let&#x27;s for days or weeks.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Let&#x27;s look at how we can run this ticker thread for every time inteval.</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">ticker_example.py</p></div><pre class="language-python:ticker_example.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">import</span><span> asyncio
</span><span></span><span class="token" style="color:#569CD6">from</span><span> ticker </span><span class="token" style="color:#569CD6">import</span><span> Ticker
</span>
<span>process_called </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">0</span><span>
</span><span></span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">process</span><span class="token" style="color:#d4d4d4">(</span><span>task_for</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#ce9178">&quot;&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">global</span><span> process_called
</span><span>    process_called </span><span class="token" style="color:#d4d4d4">+=</span><span> </span><span class="token" style="color:#b5cea8">1</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;process called for: &quot;</span><span class="token" style="color:#d4d4d4">,</span><span> process_called</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot; times&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">stop_ticker</span><span class="token" style="color:#d4d4d4">(</span><span>kill_func</span><span class="token" style="color:#d4d4d4">:</span><span> Callable</span><span class="token" style="color:#d4d4d4">,</span><span> after_time</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span>after_time</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    kill_func</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># call any cleanup functions for graceful exiting</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span></span><span class="token" style="color:#569CD6">if</span><span> __name__</span><span class="token" style="color:#d4d4d4">==</span><span class="token" style="color:#ce9178">&quot;__main__&quot;</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    cbkargs </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#ce9178">&quot;task_for&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">&quot;data-pre-process&quot;</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    ticker </span><span class="token" style="color:#d4d4d4">=</span><span> Ticker</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569cd6">True</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">,</span><span> process</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">**</span><span>cbkargs</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    ticker</span><span class="token" style="color:#d4d4d4">.</span><span>start</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span>    ev_loop </span><span class="token" style="color:#d4d4d4">=</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>get_event_loop</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    ev_loop</span><span class="token" style="color:#d4d4d4">.</span><span>run_until_complete</span><span class="token" style="color:#d4d4d4">(</span><span>stop_ticker</span><span class="token" style="color:#d4d4d4">(</span><span>ticker</span><span class="token" style="color:#d4d4d4">.</span><span>kill</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">7</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Output</p></div><pre class="language-shell:Output" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-shell" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>process called for:  </span><span class="token" style="color:#b5cea8">1</span><span>  </span><span class="token" style="color:#4ec9b0">times</span><span>
</span><span>process called for:  </span><span class="token" style="color:#b5cea8">2</span><span>  </span><span class="token" style="color:#4ec9b0">times</span><span>
</span>Exiting ticker.
</code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the above example, we have imported the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">Ticker</em> class and defined a function <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">process</em> which we pass as a callback to this ticker. This function will be called for after every ticker period and this is where we do any periodic processing like sending notifications. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The line <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">ticker = Ticker(True, 3, process, **cbkargs)</em> initializes the ticker with <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">3</strong> second time interval. We have defined another function <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">stop_ticker</em> which we will use to kill the ticker after some time. The stop ticker function will wait for some time (7 seconds here) and kill the ticker. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">As we can see in the output, the ticker called the callback every 3 seconds and got stopped by the parent thread which is our main thread here through <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">stop_ticker</em> function.</p><hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This is a very effective way of defining a ticker in Python with a simple thread mechanism. Now we will see how we can define a worker pool for processing multiple jobs by multiple workers concurrently.</p><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Worker pool/Job queue pattern</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">We can define worker pool concurrency patterns with threads alone using multi-threading. But there are limitations with threads, like:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Threads are synchronous, meaning when a thread is paused it blocks the execution also, leaving other threads for starvation </li><li>we cannot create a huge number of threads due to various reasons like memory, context switching, etc.</li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">So, we can use a coroutine to do this job because we can have an asynchronous way of doing things if have to call any API or wait to load the huge dataset, we can pause the current coroutine and let others claim the CPU. As Python is single-threaded, meaning only 1 thread can run at a time, this un-blocking way of organizing your tasks makes your Python code efficient and performant. And we can create thousands of coroutines in quick time and they occupy very little memory.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">The worker pool pattern is a simple and the most widely used concurrency pattern for distributing multiple tasks or jobs (n-jobs) to multiple workers (m-workers). Usually <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">n &gt;= m</em>. In this pattern, we have a list of jobs to be processed, and they are to be read from a static queue or a dynamic stream. And we have to distribute those jobs to idle workers who take the job and process it. Worker may or may not return the result based on the type of the Job. Idle workers are very hungry and they compete with other idle workers to take the incoming Job or un-attended Job.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/concurrency-patterns-python/job-queue-worker-pool.jpg" alt="Worker-pool pattern with Job Queue" style="width:70%;max-width:70%;height:auto;margin-left:15%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">Worker pool with Job Queue. Each idle worker takes one job at a time and processes the Job. After the job is complete, the worker will continue to take any un-attended Job.</span></span></picture></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">As in the above image, the jobs are stored in some data structure say a Job Queue, and we have a pool of workers. We usually incorporate a scheduler/distributor to assign the Jobs to idle Workers. So, at a time, if we have <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">m</strong> workers, then we can process <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">m</strong> Jobs concurrently. If we can access multiple cores, then these Jobs are processed parallelly like in Golang. Because Python has some overhead for forking multiple processes, we will stick to single-threaded concurrent execution of Jobs by multiple Workers. The following code implements this worker pool pattern where we have to process the n-number of Jobs.</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">worker_pool.py</p></div><pre class="language-python:worker_pool.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">import</span><span> asyncio
</span><span></span><span class="token" style="color:#569CD6">from</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>queues </span><span class="token" style="color:#569CD6">import</span><span> Queue
</span><span></span><span class="token" style="color:#569CD6">from</span><span> threading </span><span class="token" style="color:#569CD6">import</span><span> Thread
</span><span></span><span class="token" style="color:#569CD6">from</span><span> typing </span><span class="token" style="color:#569CD6">import</span><span> Any</span><span class="token" style="color:#d4d4d4">,</span><span> Callable</span><span class="token" style="color:#d4d4d4">,</span><span> List
</span>
<!-- -->
<span></span><span class="token" style="color:#569CD6">class</span><span> </span><span class="token" style="color:#4ec9b0">WorkerPool</span><span class="token" style="color:#d4d4d4">(</span><span>Thread</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">__init__</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        is_daemon</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        jobs</span><span class="token" style="color:#d4d4d4">:</span><span> List</span><span class="token" style="color:#d4d4d4">[</span><span>Any</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        n_workers</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        callback</span><span class="token" style="color:#d4d4d4">:</span><span> Callable</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">[</span><span>List</span><span class="token" style="color:#d4d4d4">[</span><span>Any</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#569cd6">None</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        Thread</span><span class="token" style="color:#d4d4d4">.</span><span>__init__</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>daemon </span><span class="token" style="color:#d4d4d4">=</span><span> is_daemon
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>jobs </span><span class="token" style="color:#d4d4d4">=</span><span> jobs
</span>
<span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop </span><span class="token" style="color:#d4d4d4">=</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>new_event_loop</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>set_event_loop</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>        
<span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>job_queue </span><span class="token" style="color:#d4d4d4">=</span><span> Queue</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>n_workers </span><span class="token" style="color:#d4d4d4">=</span><span> n_workers
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>callback </span><span class="token" style="color:#d4d4d4">=</span><span> callback
</span>
<span>    </span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">distribute</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">,</span><span> w_name</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">while</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>job_queue</span><span class="token" style="color:#d4d4d4">.</span><span>qsize</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            job </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">await</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>job_queue</span><span class="token" style="color:#d4d4d4">.</span><span>get</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                </span><span class="token" style="color:#6a9955"># call the callback with the Job details</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">await</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>callback</span><span class="token" style="color:#d4d4d4">(</span><span>job</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">except</span><span> Exception </span><span class="token" style="color:#569CD6">as</span><span> e</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">raise</span><span> Exception</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Exception for callback: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">e</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">finally</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                </span><span class="token" style="color:#6a9955"># mark the current job as done</span><span>
</span><span>                </span><span class="token" style="color:#6a9955"># will get an exception if it&#x27;s already done by the current worker or any other worker</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                    self</span><span class="token" style="color:#d4d4d4">.</span><span>job_queue</span><span class="token" style="color:#d4d4d4">.</span><span>task_done</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>                </span><span class="token" style="color:#569CD6">except</span><span> ValueError</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>                    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;</span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">w_name</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">: Task already done.&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>                    </span><span class="token" style="color:#569CD6">return</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">job_wp</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#6a9955"># add jobs to the job-queue.</span><span>
</span><span>        </span><span class="token" style="color:#6a9955"># this job queue can be concurrently accessed by multiple workers</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> i </span><span class="token" style="color:#569CD6">in</span><span> </span><span class="token" style="color:#ce9178">range</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">len</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>jobs</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">await</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>job_queue</span><span class="token" style="color:#d4d4d4">.</span><span>put</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>jobs</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>
<span>        tasks </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span>
</span>
<span>        </span><span class="token" style="color:#6a9955"># create multiple workers that take un-attended jobs from the job queue</span><span>
</span><span>        </span><span class="token" style="color:#6a9955"># and continuously process them until all jobs are executed</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">for</span><span> i </span><span class="token" style="color:#569CD6">in</span><span> </span><span class="token" style="color:#ce9178">range</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>n_workers</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            tasks</span><span class="token" style="color:#d4d4d4">.</span><span>append</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>distribute</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Worker: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">i</span><span class="token string-interpolation" style="color:#d4d4d4">+</span><span class="token string-interpolation" style="color:#b5cea8">1</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>
<span>        </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>gather</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">*</span><span>tasks</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">.</span><span>run_until_complete</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>job_wp</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">except</span><span> Exception </span><span class="token" style="color:#569CD6">as</span><span> e</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Error distributing jobs: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">e</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">finally</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">.</span><span>close</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Here, we extend the <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">Thread</em> class to execute WorkerPool in a separate thread. The constructor takes the list of job items, <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">n_workers</em> for how many workers to spawn, and a callback function to call with the job detail.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">WorkerPool</em> class defines two methods <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">job_wp</em> and <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">distribute</em>. <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">job_wp</em> creates a JobQueue with all jobs and also creates multiple workers each with a name <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Worker: i</strong> where <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">i</em> is ith worker. This function will wait for all workers to complete processing all Jobs.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">distribute</em> function takes the unattended job and calls the callback with job details as parameters to the callback function. We can also extend this to pass arguments. After executing the job, we finally mark that job as done.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Example of processing Jobs by multiple workers:</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">worker_pool_example.py</p></div><pre class="language-python:worker_pool_example.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">from</span><span> random </span><span class="token" style="color:#569CD6">import</span><span> randint
</span><span></span><span class="token" style="color:#569CD6">from</span><span> time </span><span class="token" style="color:#569CD6">import</span><span> time
</span><span></span><span class="token" style="color:#569CD6">from</span><span> worker_pool </span><span class="token" style="color:#569CD6">import</span><span> WorkerPool
</span>
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">process_job</span><span class="token" style="color:#d4d4d4">(</span><span>job_detail</span><span class="token" style="color:#d4d4d4">:</span><span> Any</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    time_to </span><span class="token" style="color:#d4d4d4">=</span><span> randint</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">4</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Processing job:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> job_detail</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;will take:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> time_to</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;seconds&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span>time_to</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;Completed job:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> job_detail</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span></span><span class="token" style="color:#569CD6">if</span><span> __name__</span><span class="token" style="color:#d4d4d4">==</span><span class="token" style="color:#ce9178">&quot;__main__&quot;</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    wp </span><span class="token" style="color:#d4d4d4">=</span><span> WorkerPool</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569cd6">True</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">list</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">range</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">11</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">,</span><span> process_job</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    atime </span><span class="token" style="color:#d4d4d4">=</span><span> time</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    wp</span><span class="token" style="color:#d4d4d4">.</span><span>start</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    wp</span><span class="token" style="color:#d4d4d4">.</span><span>join</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;time taken:&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">(</span><span>time</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">-</span><span>atime</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">+</span><span> </span><span class="token" style="color:#ce9178">&quot;s&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Here, we initialize the WorkerPool class with <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">10</strong> jobs and <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">3</strong> workers along with a callback <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">process_job</em>. This <em style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;background-color:#07101326;color:#071013f2;margin:0vh 0 1vh 0;padding:0 2px 0 2px;border-radius:2px">process_job</em> function might take any of <!-- -->[1, 4]<!-- --> seconds to complete.</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Output</p></div><pre class="language-shell:Output" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-shell" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>Processing job: </span><span class="token" style="color:#b5cea8">1</span><span> will take: </span><span class="token" style="color:#b5cea8">3</span><span> seconds
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">2</span><span> will take: </span><span class="token" style="color:#b5cea8">1</span><span> seconds
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">3</span><span> will take: </span><span class="token" style="color:#b5cea8">1</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">2</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">4</span><span> will take: </span><span class="token" style="color:#b5cea8">4</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">3</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">5</span><span> will take: </span><span class="token" style="color:#b5cea8">4</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">1</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">6</span><span> will take: </span><span class="token" style="color:#b5cea8">3</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">4</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">7</span><span> will take: </span><span class="token" style="color:#b5cea8">1</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">5</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">8</span><span> will take: </span><span class="token" style="color:#b5cea8">1</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">6</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">9</span><span> will take: </span><span class="token" style="color:#b5cea8">2</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">7</span><span>
</span><span>Processing job: </span><span class="token" style="color:#b5cea8">10</span><span> will take: </span><span class="token" style="color:#b5cea8">1</span><span> seconds
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">8</span><span>
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">10</span><span>
</span><span>Completed job: </span><span class="token" style="color:#b5cea8">9</span><span>
</span><span></span><span class="token" style="color:#dcdcaa">time</span><span> taken: 8s
</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">With this asynchronous processing of Jobs, we have processed all the jobs whose collective processing time requires <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">21 seconds</strong> in <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">8 seconds</strong> thanks to asyncio whereas with un-optimized multi-threading, it might take the same <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">21 seconds</strong> due to threads blocking nature.</p><hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Pipeline or Chain processing</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Pipeline pattern or Chain processing is a simple concurrency pattern of executing the multiple jobs consecutively where the input for the current job is the output of the previous job. For example, let&#x27;s say we have to analyze incoming data about customer ratings (scale: 1-5) for our service. And we have to do the following steps:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li>Analyse the feedback</li><li>If the rating is below 3, we have to store this rating for later analyses</li><li>Later generate the thank you message for the customer</li><li>Finally, based on the preference notification channel (Email or SMS) we will send a thank you message.</li></ul><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">This whole process needs a couple of logical decisions to take at each level of processing. Based on multi-logic flow, we can divide the above process into small functions and we execute each function sequentially based on where the next function call is decided based on the current input data.</p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><picture class="jsx-2944168904"><img src="/images/concurrency-patterns-python/pipeline-or-chain-concurrency-processing.jpg" alt="Pipeline or Chain processing concurrency patter" style="width:100%;max-width:100%;height:auto;margin-left:0%" class="jsx-2944168904"/><span class="jsx-2944168904 img-text"><span class="jsx-2944168904">Processing pipeline/flow</span></span></picture></p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If we have multiple customer ratings to be analyzed we can combine the <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">WorkerPool</strong> pattern with this Pipeline pattern.</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">pipeline.py</p></div><pre class="language-python:pipeline.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>imoport asyncio
</span><span></span><span class="token" style="color:#569CD6">import</span><span> random
</span><span></span><span class="token" style="color:#569CD6">from</span><span> worker_pool </span><span class="token" style="color:#569CD6">import</span><span> WorkerPool
</span>            
<span>commuincation_type </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;email&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#ce9178">&quot;sms&quot;</span><span class="token" style="color:#d4d4d4">]</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">process_rating</span><span class="token" style="color:#d4d4d4">(</span><span>job</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">list</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    rating</span><span class="token" style="color:#d4d4d4">,</span><span> user</span><span class="token" style="color:#d4d4d4">,</span><span> idx </span><span class="token" style="color:#d4d4d4">=</span><span> job
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;1. processing rating, for item: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">idx</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">, rating: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">rating</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178"> by user: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">user</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># some processing</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">if</span><span> rating </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> </span><span class="token" style="color:#b5cea8">2</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">await</span><span> store_for_analyses</span><span class="token" style="color:#d4d4d4">(</span><span>rating</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">else</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">await</span><span> form_thankyou_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>        
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">store_for_analyses</span><span class="token" style="color:#d4d4d4">(</span><span>rating</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;1a. storing for analyses, for item: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">idx</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># store in some datastore</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">form_thankyou_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;2. forming thank-you message, for item: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">idx</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># a DB call to fetch the user details</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span>    </span><span class="token" style="color:#6a9955"># communication medium may be {email, sms}</span><span>
</span><span>    cs </span><span class="token" style="color:#d4d4d4">=</span><span> random</span><span class="token" style="color:#d4d4d4">.</span><span>choices</span><span class="token" style="color:#d4d4d4">(</span><span>commuincation_type</span><span class="token" style="color:#d4d4d4">,</span><span> weights</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0.5</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.5</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> k</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">]</span><span>
</span>    
<span>    </span><span class="token" style="color:#569CD6">match</span><span> cs</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">case</span><span> </span><span class="token" style="color:#ce9178">&quot;email&quot;</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">await</span><span> send_email_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">case</span><span> </span><span class="token" style="color:#ce9178">&quot;sms&quot;</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">await</span><span> send_sms_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">case</span><span> </span><span class="token" style="color:#569CD6">_</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">return</span><span>
</span>        
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">send_email_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;2a. sending email message, for item: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">idx</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">, for user: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">user</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># sendinig might take time</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">send_sms_message</span><span class="token" style="color:#d4d4d4">(</span><span>user</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">str</span><span class="token" style="color:#d4d4d4">,</span><span> idx</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">int</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;2b. sending sms message, for item: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">idx</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">, for user: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">user</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># sendinig might take time</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">await</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>sleep</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<!-- -->    
<span></span><span class="token" style="color:#569CD6">if</span><span> __name__</span><span class="token" style="color:#d4d4d4">==</span><span class="token" style="color:#ce9178">&quot;__main__&quot;</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#6a9955"># create ratings, users, and items</span><span>
</span><span>    n </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">10</span><span>
</span><span>    ratings </span><span class="token" style="color:#d4d4d4">=</span><span> random</span><span class="token" style="color:#d4d4d4">.</span><span>choices</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">2</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">4</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">5</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> weights</span><span class="token" style="color:#d4d4d4">=</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#b5cea8">0.25</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.25</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.15</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.15</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.2</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> k</span><span class="token" style="color:#d4d4d4">=</span><span>n</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    items </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">list</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">range</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">,</span><span> n</span><span class="token" style="color:#d4d4d4">+</span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    users </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#ce9178">list</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">map</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">lambda</span><span> x</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token string-interpolation" style="color:#ce9178">f&quot;User </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">x</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">,</span><span> items</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span>    jobs </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">for</span><span> i </span><span class="token" style="color:#569CD6">in</span><span> </span><span class="token" style="color:#ce9178">range</span><span class="token" style="color:#d4d4d4">(</span><span>n</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        jobs</span><span class="token" style="color:#d4d4d4">.</span><span>append</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">[</span><span>ratings</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> users</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> items</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>    
<span>    wp </span><span class="token" style="color:#d4d4d4">=</span><span> WorkerPool</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569cd6">True</span><span class="token" style="color:#d4d4d4">,</span><span> jobs</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">3</span><span class="token" style="color:#d4d4d4">,</span><span> process_rating</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    wp</span><span class="token" style="color:#d4d4d4">.</span><span>start</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    wp</span><span class="token" style="color:#d4d4d4">.</span><span>join</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Here we define a list of functions that are depicted in the image above. Each function will take input from the previous function and apply its decision logic to call which function next. </p><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">In the example, we have created 10 rating items to be processed by 3 workers. The output of the processing is</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">Output</p></div><pre class="language-:Output" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>1. processing rating, for item: 1, rating: 4 by user: User 1
</span>1. processing rating, for item: 2, rating: 3 by user: User 2
<!-- -->1. processing rating, for item: 3, rating: 3 by user: User 3
<!-- -->2. forming thank-you message, for item: 1
<!-- -->2. forming thank-you message, for item: 2
<!-- -->2. forming thank-you message, for item: 3
<!-- -->2b. sending sms message, for item: 1, for user: User 1
<!-- -->2a. sending email message, for item: 2, for user: User 2
<!-- -->2a. sending email message, for item: 3, for user: User 3
<!-- -->1. processing rating, for item: 4, rating: 2 by user: User 4
<!-- -->1. processing rating, for item: 5, rating: 5 by user: User 5
<!-- -->1. processing rating, for item: 6, rating: 4 by user: User 6
<!-- -->1a. storing for analyses, for item: 4
<!-- -->2. forming thank-you message, for item: 5
<!-- -->2. forming thank-you message, for item: 6
<!-- -->1. processing rating, for item: 7, rating: 5 by user: User 7
<!-- -->2a. sending email message, for item: 5, for user: User 5
<!-- -->2b. sending sms message, for item: 6, for user: User 6
<!-- -->2. forming thank-you message, for item: 7
<!-- -->1. processing rating, for item: 8, rating: 5 by user: User 8
<!-- -->1. processing rating, for item: 9, rating: 1 by user: User 9
<!-- -->2b. sending sms message, for item: 7, for user: User 7
<!-- -->2. forming thank-you message, for item: 8
<!-- -->1a. storing for analyses, for item: 9
<!-- -->1. processing rating, for item: 10, rating: 5 by user: User 10
<!-- -->2b. sending sms message, for item: 8, for user: User 8
<!-- -->2. forming thank-you message, for item: 10
<!-- -->2b. sending sms message, for item: 10, for user: User 10
</code></pre></div></pre><hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/><h2 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 1vw);color:#1d2b35;margin:1vh 0 1vh 0;overflow-wrap:break-word" id="">Custom coroutine</h2><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">If you want an asynchronous function in a separate thread with the async capabilities, we can run a coroutine as follows</p><pre><div class="jsx-1110062031"><div class="jsx-1110062031 file-name-container"><p class="jsx-1110062031 file-name">coroutine.py</p></div><pre class="language-python:coroutine.py" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:0px;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-python" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">import</span><span> asyncio
</span><span></span><span class="token" style="color:#569CD6">from</span><span> threading </span><span class="token" style="color:#569CD6">import</span><span> Thread
</span><span></span><span class="token" style="color:#569CD6">from</span><span> typing </span><span class="token" style="color:#569CD6">import</span><span> Any</span><span class="token" style="color:#d4d4d4">,</span><span> Callable</span><span class="token" style="color:#d4d4d4">,</span><span> List</span><span class="token" style="color:#d4d4d4">,</span><span> Optional
</span>
<span></span><span class="token" style="color:#569CD6">class</span><span> </span><span class="token" style="color:#4ec9b0">CustomCoroutine</span><span class="token" style="color:#d4d4d4">(</span><span>Thread</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">__init__</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        is_daemon</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">bool</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>        callback</span><span class="token" style="color:#d4d4d4">:</span><span> Callable</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#d4d4d4">[</span><span>List</span><span class="token" style="color:#d4d4d4">[</span><span>Any</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#569cd6">None</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> 
</span><span>        </span><span class="token" style="color:#d4d4d4">**</span><span>cbkwargs</span><span class="token" style="color:#d4d4d4">:</span><span> Optional</span><span class="token" style="color:#d4d4d4">[</span><span>Any</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        Thread</span><span class="token" style="color:#d4d4d4">.</span><span>__init__</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>daemon </span><span class="token" style="color:#d4d4d4">=</span><span> is_daemon
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop </span><span class="token" style="color:#d4d4d4">=</span><span> asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>new_event_loop</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        asyncio</span><span class="token" style="color:#d4d4d4">.</span><span>set_event_loop</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>callback </span><span class="token" style="color:#d4d4d4">=</span><span> callback
</span><span>        self</span><span class="token" style="color:#d4d4d4">.</span><span>cbkwargs </span><span class="token" style="color:#d4d4d4">=</span><span> cbkwargs
</span>
<span>    </span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">callback</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#569cd6">None</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">await</span><span> self</span><span class="token" style="color:#d4d4d4">.</span><span>callback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">**</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>cbkwargs</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">except</span><span> Exception </span><span class="token" style="color:#569CD6">as</span><span> e</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            </span><span class="token" style="color:#569CD6">print</span><span class="token" style="color:#d4d4d4">(</span><span class="token string-interpolation" style="color:#ce9178">f&quot;Error calling callback: </span><span class="token string-interpolation" style="color:#d4d4d4">{</span><span class="token string-interpolation" style="color:#9cdcfe">e</span><span class="token string-interpolation" style="color:#d4d4d4">}</span><span class="token string-interpolation" style="color:#ce9178">&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">def</span><span> </span><span class="token" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#569cd6">None</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">try</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">.</span><span>run_until_complete</span><span class="token" style="color:#d4d4d4">(</span><span>self</span><span class="token" style="color:#d4d4d4">.</span><span>callback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>        </span><span class="token" style="color:#569CD6">finally</span><span class="token" style="color:#d4d4d4">:</span><span>
</span><span>            self</span><span class="token" style="color:#d4d4d4">.</span><span>event_loop</span><span class="token" style="color:#d4d4d4">.</span><span>close</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span></code></pre></div></pre><hr style="margin:2vh 25% 2vh 25%;border:1px solid #07101380"/><p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">I hope the above concurrency patterns give you some understanding of organizing your Python code for better performance and optimization. Other concurrency patterns that are worth noting are:</p><ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word"><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Monitor pattern</strong>: <strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">n</strong> number of threads waiting on some condition to be true, if the condition is not true, those threads need to be in a sleep state and pushed to the wait queue, and they have to be notified when the condition becomes true.</li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Double Checked locking</strong>: for creating concurrent objects. (Ex: Singleton design pattern)</li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Barrier pattern</strong>: All concurrently executing threads must wait for others to complete and wait at a point called barrier.</li><li><strong style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);font-style:normal;font-weight:bold;color:#1d2b35f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Reactor pattern</strong>: In an event-driven system, a service handler accepts events from multiple incoming requests and demultiplexes to respective non-blocking handlers.</li></ul></article><div class="jsx-1393389675 footer-container"><div class="jsx-1393389675 footer-container-links"><div class="jsx-1393389675 footer-links"><div class="jsx-1393389675 link-item"><a href="https://github.com/santhalakshminarayana" rel="noreferrer" target=" _blank" class="jsx-1393389675 link"><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" style="color:#fffecb;font-size:calc(0.8rem + 1vw)" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></div></a></div><div class="jsx-1393389675 link-item"><a href="https://www.linkedin.com/in/santhalakshminarayana/" rel="noreferrer" target="_blank" class="jsx-1393389675 link"><div><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" style="color:#fffecb;font-size:calc(0.8rem + 1vw)" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></div></a></div></div></div><div class="jsx-1393389675 copy-right-container"><p class="jsx-1393389675 copy-right-text">Santha Lakshmi Narayana  2023</p></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postMetadata":{"title":"Asynchronous or Concurrency patterns in Python with Asyncio","description":"Effective implementation of asynchronous or concurrency patterns like Background task and Worker Pool in Python using Asyncio.","imgName":"concurrency-patterns-python/concurrency-patterns-python.jpg","date":"Mar 6, 2024","tags":["concurrency","python-performance","python"],"keywords":["concurrency","asyncio","python-concurrency","worker-pool","job-queue","worker-queue","background-thread","background-task","background-job","python-performance","python-optimize","python","fast-python","speed"],"id":"concurrency-patterns-python"},"postContent":{"compiledSource":"var m=Object.defineProperty,h=Object.defineProperties;var d=Object.getOwnPropertyDescriptors;var n=Object.getOwnPropertySymbols;var s=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable;var l=(e,a,o)=\u003ea in e?m(e,a,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[a]=o,t=(e,a)=\u003e{for(var o in a||(a={}))s.call(a,o)\u0026\u0026l(e,o,a[o]);if(n)for(var o of n(a))i.call(a,o)\u0026\u0026l(e,o,a[o]);return e},c=(e,a)=\u003eh(e,d(a));var p=(e,a)=\u003e{var o={};for(var r in e)s.call(e,r)\u0026\u0026a.indexOf(r)\u003c0\u0026\u0026(o[r]=e[r]);if(e!=null\u0026\u0026n)for(var r of n(e))a.indexOf(r)\u003c0\u0026\u0026i.call(e,r)\u0026\u0026(o[r]=e[r]);return o};const layoutProps={},MDXLayout=\"wrapper\";function MDXContent(o){var r=o,{components:e}=r,a=p(r,[\"components\"]);return mdx(MDXLayout,c(t(t({},layoutProps),a),{components:e,mdxType:\"MDXLayout\"}),mdx(\"p\",null,mdx(\"img\",t({parentName:\"p\"},{src:\"concurrency-patterns-python/concurrency-patterns-python.jpg\",alt:\"Asynchronous or Concurrency Patterns in Python\"}))),mdx(\"h6\",null,\"Published on: \",mdx(\"strong\",{parentName:\"h6\"},\"Mar 6, 2024\")),mdx(\"h1\",null,\"Asynchronous or Concurrency Patterns in Python with Asyncio\"),mdx(\"p\",null,\"Most software development tasks require an asynchronous way of handling things like running background tasks, processing multiple tasks at a time, applying the same operations on huge data, distributing tasks to free workers, etc. In this blog, we will see how can we achieve some of these patterns with Python. \"),mdx(\"p\",null,\"Before delving into the concept, the most important thing we need to understand is \",mdx(\"em\",{parentName:\"p\"},\"concurrency vs parallelism\"),\". Concurrency is about handling multiple tasks at a time and this handling might be in parallel or not. Whereas parallelism is about doing multiple tasks parallelly/simultaneously at a time. Parallelism can be termed as concurrency but not vice-versa. \"),mdx(\"p\",null,\"In my earlier blog posts about \",mdx(\"a\",t({parentName:\"p\"},{href:\"https://santhalakshminarayana.github.io/blog/super-fast-python-multi-processing\"}),\"Super Fast Python: Multiprocessing\"),\", I have described how can achieve parallelism with Python.\"),mdx(\"p\",null,\"One can ask, in parallelism, if we can do multiple things at a time, why do we need to focus on concurrency at all? The answer to this question simply depends on the program language in the discussion. Some program languages like C/C++ are built to directly use multiple cores/vCPUs of the host machine for parallelism, while other languages like Golang can still utilize multiple cores but with concurrency, not parallel. Both of these types of languages can do both concurrency and parallelism very smoothly. But we have a special child like Python, whose creators put so many restrictions (which are thoughtful at creation) to be a better resource utiliser. GIL in Python makes the Python interpreter run only one thread at a time and cannot multiplex the multiple threads to multiple cores. I have already discussed this in my previous post about \",mdx(\"a\",t({parentName:\"p\"},{href:\"https://santhalakshminarayana.github.io/blog/super-fast-python-why-python-slow\"}),\"Why Python is Slow\"),\".\"),mdx(\"p\",null,\"To utilize multiple cores, we have to create at least one process per core. The creation and memory management of the process is time-consuming and comes with its overheads. So, a general rule of thumb is to use multi-programming for CPU-intensive tasks, and I/O bound tasks like network calls, and reading from disk are handled concurrently with threads. As we can use multi-threading in Python, creating and managing a huge number of threads is not optimal in Python or any high-level language. The solution to create and manage huge numbers of thread-like objects say in thousands or 100s of thousands, we can use Co-routines which can be termed as virtual threads or small threads whose memory footprint is very minimal compared to threads. And we can spawn thousands of these in a few microseconds.\"),mdx(\"p\",null,\"Coroutines are part of core Python and are handled with an in-built package called \",mdx(\"a\",t({parentName:\"p\"},{href:\"https://docs.python.org/3/library/asyncio.html\"}),\"asyncio\")),mdx(\"p\",null,\"The goal of this article is to demonstrate some concurrency patterns rather than learning about coroutines. So, it's expected to have some basic background with \",mdx(\"em\",{parentName:\"p\"},\"asyncio\"),\".\"),mdx(\"p\",null,\"In the following sections, we cover the two most used concurrency patterns:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Background tasks with Ticker\"),mdx(\"li\",{parentName:\"ul\"},\"WorkerPool pattern\"),mdx(\"li\",{parentName:\"ul\"},\"Pipeline or Chain processing\")),mdx(\"h2\",null,\"Ticker \u0026 Background tasks\"),mdx(\"p\",null,\"Let's say we have a stream of data coming and stored in some data sources like Database, Redis, or in the Cloud. And we want to analyze that data periodically let's say every 1 day and send an email notification to the customers with the analyzed report. This is a basic CRON job that we execute in Linux. \"),mdx(\"p\",null,\"If you don't know what the is ticker, it is a kind of background task where the program will be notified for every time interval that we need to do some task. Tickers are all over any periodic notification or job updates. \"),mdx(\"p\",null,\"We will use a ticker for our coroutine to come into the foreground and call a callback that it receives with callback arguments. Let's look at the following ticker class\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:ticker.py\"}),`from threading import Event, Thread\nfrom typing import Any, Callable, Optional\n\nclass Ticker(Thread):\n    def __init__(\n        self, \n        is_daemon: bool, \n        tick_period: int, \n        callback: Callable, \n        **cbkwargs: Optional[Any]\n    ):\n        Thread.__init__(self)\n        self.daemon = is_daemon\n        self.tick_period = tick_period\n        self.task_kill_event = Event()\n        self.callback = callback\n        self.cbkwargs = cbkwargs\n\n    def kill(self):\n        self.task_kill_event.set()\n\n    def run(self):\n        while True:\n            is_killed = self.task_kill_event.wait(self.tick_period)\n            if is_killed:\n                print(\"Exiting ticker.\")\n                break\n\n            # call the callback\n            self.callback(**self.cbkwargs)\n`)),mdx(\"p\",null,\"This class inherits the \",mdx(\"em\",{parentName:\"p\"},\"Thread\"),\" class to implement custom thread functionality. In the constructor, we pass the \",mdx(\"em\",{parentName:\"p\"},\"is_daemon\"),\" flag that makes the current thread run as a daemon or not. Usually for background tasks that do not stick to the application lifecycle, they are not meant to be daemon. And other params like \",mdx(\"em\",{parentName:\"p\"},\"tick_period\"),\" which says the time interval for the ticker, \",mdx(\"em\",{parentName:\"p\"},\"callback\"),\" is a callback function, and \",mdx(\"em\",{parentName:\"p\"},\"cbkwargs\"),\" are callback key arguments to pass to this callback function. We will speak about \",mdx(\"em\",{parentName:\"p\"},\"self.task_kill_event = Event()\"),\" later.\"),mdx(\"p\",null,\"This class has two methods \",mdx(\"em\",{parentName:\"p\"},\"kill\"),\" and \",mdx(\"em\",{parentName:\"p\"},\"run\"),\" where \",mdx(\"em\",{parentName:\"p\"},\"run\"),\" is an overridden \",mdx(\"em\",{parentName:\"p\"},\"Thread\"),\" class function. \"),mdx(\"p\",null,mdx(\"a\",t({parentName:\"p\"},{href:\"https://docs.python.org/3/library/threading.html#event-objects\"}),mdx(\"em\",{parentName:\"a\"},\"threading.Event()\")),\" object is used for communication between threads. It's simply a boolean flag that one thread signals the other thread that listens to this event object states. We use an event object to signal for the background task to exit. This is what the \",mdx(\"em\",{parentName:\"p\"},\"kill\"),\" function is. If we call this function, it will set the event to be \",mdx(\"strong\",{parentName:\"p\"},\"True\"),\" signaling the listing thread.\"),mdx(\"p\",null,\"The overriding \",mdx(\"em\",{parentName:\"p\"},\"run\"),\" method is a classic implementation of a background running thread, it will run in a loop until it receives the \",mdx(\"em\",{parentName:\"p\"},\"is_killed\"),\" to be \",mdx(\"strong\",{parentName:\"p\"},\"True\"),\" which we set by calling \",mdx(\"em\",{parentName:\"p\"},\"kill\"),\". \",mdx(\"em\",{parentName:\"p\"},\"self.task_kill_event.wait(self.tick_period)\"),\" is where the magic happens. Here we will wait for the specified ticker period for that event to be set. After the specified interval period, if we don't receive the event signal, the \",mdx(\"strong\",{parentName:\"p\"},\"is_killed\"),\" will be False, and we will call the callback with the keyword arguments.\"),mdx(\"p\",null,\"Why don't we use a simple \",mdx(\"em\",{parentName:\"p\"},\"thread.sleep\"),\" for sleeping in the background? Let's say, that while waiting for a ticker period, we get the event signal, then we have to right away exit the thread. For example, if the ticker period is for 10 seconds, and while in the 6th second, we get the signal, we will exit there instead of waiting for the other 4 seconds. This can't be achieved with thread sleep. This is very useful if we are running larger ticker periods let's for days or weeks.\"),mdx(\"p\",null,\"Let's look at how we can run this ticker thread for every time inteval.\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:ticker_example.py\"}),`import asyncio\nfrom ticker import Ticker\n\nprocess_called = 0\ndef process(task_for=\"\"):\n    global process_called\n    process_called += 1\n    print(\"process called for: \", process_called, \" times\")\n    \nasync def stop_ticker(kill_func: Callable, after_time: int):\n    await asyncio.sleep(after_time)\n    kill_func()\n    # call any cleanup functions for graceful exiting\n    await asyncio.sleep(1)\n    \nif __name__==\"__main__\":\n    cbkargs = {\"task_for\": \"data-pre-process\"}\n    ticker = Ticker(True, 3, process, **cbkargs)\n    ticker.start()\n    \n    ev_loop = asyncio.get_event_loop()\n    ev_loop.run_until_complete(stop_ticker(ticker.kill, 7))\n`)),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-shell:Output\"}),`process called for:  1  times\nprocess called for:  2  times\nExiting ticker.\n`)),mdx(\"p\",null,\"In the above example, we have imported the \",mdx(\"em\",{parentName:\"p\"},\"Ticker\"),\" class and defined a function \",mdx(\"em\",{parentName:\"p\"},\"process\"),\" which we pass as a callback to this ticker. This function will be called for after every ticker period and this is where we do any periodic processing like sending notifications. \"),mdx(\"p\",null,\"The line \",mdx(\"em\",{parentName:\"p\"},\"ticker = Ticker(True, 3, process, **cbkargs)\"),\" initializes the ticker with \",mdx(\"strong\",{parentName:\"p\"},\"3\"),\" second time interval. We have defined another function \",mdx(\"em\",{parentName:\"p\"},\"stop_ticker\"),\" which we will use to kill the ticker after some time. The stop ticker function will wait for some time (7 seconds here) and kill the ticker. \"),mdx(\"p\",null,\"As we can see in the output, the ticker called the callback every 3 seconds and got stopped by the parent thread which is our main thread here through \",mdx(\"em\",{parentName:\"p\"},\"stop_ticker\"),\" function.\"),mdx(\"hr\",null),mdx(\"p\",null,\"This is a very effective way of defining a ticker in Python with a simple thread mechanism. Now we will see how we can define a worker pool for processing multiple jobs by multiple workers concurrently.\"),mdx(\"h2\",null,\"Worker pool/Job queue pattern\"),mdx(\"p\",null,\"We can define worker pool concurrency patterns with threads alone using multi-threading. But there are limitations with threads, like:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Threads are synchronous, meaning when a thread is paused it blocks the execution also, leaving other threads for starvation \"),mdx(\"li\",{parentName:\"ul\"},\"we cannot create a huge number of threads due to various reasons like memory, context switching, etc.\")),mdx(\"p\",null,\"So, we can use a coroutine to do this job because we can have an asynchronous way of doing things if have to call any API or wait to load the huge dataset, we can pause the current coroutine and let others claim the CPU. As Python is single-threaded, meaning only 1 thread can run at a time, this un-blocking way of organizing your tasks makes your Python code efficient and performant. And we can create thousands of coroutines in quick time and they occupy very little memory.\"),mdx(\"p\",null,\"The worker pool pattern is a simple and the most widely used concurrency pattern for distributing multiple tasks or jobs (n-jobs) to multiple workers (m-workers). Usually \",mdx(\"em\",{parentName:\"p\"},\"n \u003e= m\"),\". In this pattern, we have a list of jobs to be processed, and they are to be read from a static queue or a dynamic stream. And we have to distribute those jobs to idle workers who take the job and process it. Worker may or may not return the result based on the type of the Job. Idle workers are very hungry and they compete with other idle workers to take the incoming Job or un-attended Job.\"),mdx(\"p\",null,mdx(\"img\",t({parentName:\"p\"},{src:\"concurrency-patterns-python/job-queue-worker-pool.jpg\",alt:\"Worker-pool pattern with Job Queue:=:70:=:Worker pool with Job Queue. Each idle worker takes one job at a time and processes the Job. After the job is complete, the worker will continue to take any un-attended Job.\"}))),mdx(\"p\",null,\"As in the above image, the jobs are stored in some data structure say a Job Queue, and we have a pool of workers. We usually incorporate a scheduler/distributor to assign the Jobs to idle Workers. So, at a time, if we have \",mdx(\"strong\",{parentName:\"p\"},\"m\"),\" workers, then we can process \",mdx(\"strong\",{parentName:\"p\"},\"m\"),\" Jobs concurrently. If we can access multiple cores, then these Jobs are processed parallelly like in Golang. Because Python has some overhead for forking multiple processes, we will stick to single-threaded concurrent execution of Jobs by multiple Workers. The following code implements this worker pool pattern where we have to process the n-number of Jobs.\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:worker_pool.py\"}),`import asyncio\nfrom asyncio.queues import Queue\nfrom threading import Thread\nfrom typing import Any, Callable, List\n\n\nclass WorkerPool(Thread):\n    def __init__(\n        self,\n        is_daemon: bool,\n        jobs: List[Any],\n        n_workers: int,\n        callback: Callable[[List[Any]], None],\n    ):\n        Thread.__init__(self)\n        self.daemon = is_daemon\n        self.jobs = jobs\n\n        self.event_loop = asyncio.new_event_loop()\n        asyncio.set_event_loop(self.event_loop)\n        \n        self.job_queue = Queue()\n        self.n_workers = n_workers\n        self.callback = callback\n\n    async def distribute(self, w_name: str):\n        while self.job_queue.qsize() \u003e 0:\n            job = await self.job_queue.get()\n            try:\n                # call the callback with the Job details\n                await self.callback(job)\n            except Exception as e:\n                raise Exception(f\"Exception for callback: {e}\")\n            finally:\n                # mark the current job as done\n                # will get an exception if it's already done by the current worker or any other worker\n                try:\n                    self.job_queue.task_done()\n                except ValueError:\n                    print(f\"{w_name}: Task already done.\")\n                    return\n\n    async def job_wp(self):\n        # add jobs to the job-queue.\n        # this job queue can be concurrently accessed by multiple workers\n        for i in range(len(self.jobs)):\n            await self.job_queue.put(self.jobs[i])\n\n        tasks = []\n\n        # create multiple workers that take un-attended jobs from the job queue\n        # and continuously process them until all jobs are executed\n        for i in range(self.n_workers):\n            tasks.append(self.distribute(f\"Worker: {i+1}\"))\n\n        await asyncio.gather(*tasks)\n\n    def run(self):\n        try:\n            self.event_loop.run_until_complete(self.job_wp())\n        except Exception as e:\n            print(f\"Error distributing jobs: {e}\")\n        finally:\n            self.event_loop.close()\n`)),mdx(\"p\",null,\"Here, we extend the \",mdx(\"em\",{parentName:\"p\"},\"Thread\"),\" class to execute WorkerPool in a separate thread. The constructor takes the list of job items, \",mdx(\"em\",{parentName:\"p\"},\"n_workers\"),\" for how many workers to spawn, and a callback function to call with the job detail.\"),mdx(\"p\",null,mdx(\"em\",{parentName:\"p\"},\"WorkerPool\"),\" class defines two methods \",mdx(\"em\",{parentName:\"p\"},\"job_wp\"),\" and \",mdx(\"em\",{parentName:\"p\"},\"distribute\"),\". \",mdx(\"em\",{parentName:\"p\"},\"job_wp\"),\" creates a JobQueue with all jobs and also creates multiple workers each with a name \",mdx(\"strong\",{parentName:\"p\"},\"Worker: i\"),\" where \",mdx(\"em\",{parentName:\"p\"},\"i\"),\" is ith worker. This function will wait for all workers to complete processing all Jobs.\"),mdx(\"p\",null,mdx(\"em\",{parentName:\"p\"},\"distribute\"),\" function takes the unattended job and calls the callback with job details as parameters to the callback function. We can also extend this to pass arguments. After executing the job, we finally mark that job as done.\"),mdx(\"p\",null,\"Example of processing Jobs by multiple workers:\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:worker_pool_example.py\"}),`from random import randint\nfrom time import time\nfrom worker_pool import WorkerPool\n\nasync def process_job(job_detail: Any):\n    time_to = randint(1, 4)\n    print(\"Processing job:\", job_detail, \"will take:\", time_to, \"seconds\")\n    await asyncio.sleep(time_to)\n    print(\"Completed job:\", job_detail)\n    \nif __name__==\"__main__\":\n    wp = WorkerPool(True, list(range(1, 11)), 3, process_job)\n    atime = time()\n    wp.start()\n    wp.join()\n    print(\"time taken:\", str(int(time()-atime)) + \"s\")\n`)),mdx(\"p\",null,\"Here, we initialize the WorkerPool class with \",mdx(\"strong\",{parentName:\"p\"},\"10\"),\" jobs and \",mdx(\"strong\",{parentName:\"p\"},\"3\"),\" workers along with a callback \",mdx(\"em\",{parentName:\"p\"},\"process_job\"),\". This \",mdx(\"em\",{parentName:\"p\"},\"process_job\"),\" function might take any of \",\"[1, 4]\",\" seconds to complete.\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-shell:Output\"}),`Processing job: 1 will take: 3 seconds\nProcessing job: 2 will take: 1 seconds\nProcessing job: 3 will take: 1 seconds\nCompleted job: 2\nProcessing job: 4 will take: 4 seconds\nCompleted job: 3\nProcessing job: 5 will take: 4 seconds\nCompleted job: 1\nProcessing job: 6 will take: 3 seconds\nCompleted job: 4\nProcessing job: 7 will take: 1 seconds\nCompleted job: 5\nProcessing job: 8 will take: 1 seconds\nCompleted job: 6\nProcessing job: 9 will take: 2 seconds\nCompleted job: 7\nProcessing job: 10 will take: 1 seconds\nCompleted job: 8\nCompleted job: 10\nCompleted job: 9\ntime taken: 8s\n`)),mdx(\"p\",null,\"With this asynchronous processing of Jobs, we have processed all the jobs whose collective processing time requires \",mdx(\"strong\",{parentName:\"p\"},\"21 seconds\"),\" in \",mdx(\"strong\",{parentName:\"p\"},\"8 seconds\"),\" thanks to asyncio whereas with un-optimized multi-threading, it might take the same \",mdx(\"strong\",{parentName:\"p\"},\"21 seconds\"),\" due to threads blocking nature.\"),mdx(\"hr\",null),mdx(\"h2\",null,\"Pipeline or Chain processing\"),mdx(\"p\",null,\"Pipeline pattern or Chain processing is a simple concurrency pattern of executing the multiple jobs consecutively where the input for the current job is the output of the previous job. For example, let's say we have to analyze incoming data about customer ratings (scale: 1-5) for our service. And we have to do the following steps:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},\"Analyse the feedback\"),mdx(\"li\",{parentName:\"ul\"},\"If the rating is below 3, we have to store this rating for later analyses\"),mdx(\"li\",{parentName:\"ul\"},\"Later generate the thank you message for the customer\"),mdx(\"li\",{parentName:\"ul\"},\"Finally, based on the preference notification channel (Email or SMS) we will send a thank you message.\")),mdx(\"p\",null,\"This whole process needs a couple of logical decisions to take at each level of processing. Based on multi-logic flow, we can divide the above process into small functions and we execute each function sequentially based on where the next function call is decided based on the current input data.\"),mdx(\"p\",null,mdx(\"img\",t({parentName:\"p\"},{src:\"concurrency-patterns-python/pipeline-or-chain-concurrency-processing.jpg\",alt:\"Pipeline or Chain processing concurrency patter:=:100:=:Processing pipeline/flow\"}))),mdx(\"p\",null,\"If we have multiple customer ratings to be analyzed we can combine the \",mdx(\"strong\",{parentName:\"p\"},\"WorkerPool\"),\" pattern with this Pipeline pattern.\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:pipeline.py\"}),`imoport asyncio\nimport random\nfrom worker_pool import WorkerPool\n            \ncommuincation_type = [\"email\", \"sms\"]\n\nasync def process_rating(job: list):\n    rating, user, idx = job\n    print(f\"1. processing rating, for item: {idx}, rating: {rating} by user: {user}\")\n    # some processing\n    await asyncio.sleep(1)\n    if rating \u003c= 2:\n        await store_for_analyses(rating, idx)\n    else:\n        await form_thankyou_message(user, idx)\n        \nasync def store_for_analyses(rating: int, idx: int):\n    print(f\"1a. storing for analyses, for item: {idx}\")\n    # store in some datastore\n    await asyncio.sleep(1)\n    \nasync def form_thankyou_message(user: str, idx: int):\n    print(f\"2. forming thank-you message, for item: {idx}\")\n    # a DB call to fetch the user details\n    await asyncio.sleep(1)\n    \n    # communication medium may be {email, sms}\n    cs = random.choices(commuincation_type, weights=[0.5, 0.5], k=1)[0]\n    \n    match cs:\n        case \"email\":\n            await send_email_message(user, idx)\n        case \"sms\":\n            await send_sms_message(user, idx)\n        case _:\n            return\n        \nasync def send_email_message(user: str, idx: int):\n    print(f\"2a. sending email message, for item: {idx}, for user: {user}\")\n    # sendinig might take time\n    await asyncio.sleep(1)\n    \nasync def send_sms_message(user: str, idx: int):\n    print(f\"2b. sending sms message, for item: {idx}, for user: {user}\")\n    # sendinig might take time\n    await asyncio.sleep(1)\n    \n    \nif __name__==\"__main__\":\n    # create ratings, users, and items\n    n = 10\n    ratings = random.choices([1, 2, 3, 4, 5], weights=[0.25, 0.25, 0.15, 0.15, 0.2], k=n)\n    items = list(range(1, n+1))\n    users = list(map(lambda x: f\"User {x}\", items))\n    \n    jobs = []\n    for i in range(n):\n        jobs.append([ratings[i], users[i], items[i]])\n    \n    wp = WorkerPool(True, jobs, 3, process_rating)\n    wp.start()\n    wp.join()\n`)),mdx(\"p\",null,\"Here we define a list of functions that are depicted in the image above. Each function will take input from the previous function and apply its decision logic to call which function next. \"),mdx(\"p\",null,\"In the example, we have created 10 rating items to be processed by 3 workers. The output of the processing is\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-:Output\"}),`1. processing rating, for item: 1, rating: 4 by user: User 1\n1. processing rating, for item: 2, rating: 3 by user: User 2\n1. processing rating, for item: 3, rating: 3 by user: User 3\n2. forming thank-you message, for item: 1\n2. forming thank-you message, for item: 2\n2. forming thank-you message, for item: 3\n2b. sending sms message, for item: 1, for user: User 1\n2a. sending email message, for item: 2, for user: User 2\n2a. sending email message, for item: 3, for user: User 3\n1. processing rating, for item: 4, rating: 2 by user: User 4\n1. processing rating, for item: 5, rating: 5 by user: User 5\n1. processing rating, for item: 6, rating: 4 by user: User 6\n1a. storing for analyses, for item: 4\n2. forming thank-you message, for item: 5\n2. forming thank-you message, for item: 6\n1. processing rating, for item: 7, rating: 5 by user: User 7\n2a. sending email message, for item: 5, for user: User 5\n2b. sending sms message, for item: 6, for user: User 6\n2. forming thank-you message, for item: 7\n1. processing rating, for item: 8, rating: 5 by user: User 8\n1. processing rating, for item: 9, rating: 1 by user: User 9\n2b. sending sms message, for item: 7, for user: User 7\n2. forming thank-you message, for item: 8\n1a. storing for analyses, for item: 9\n1. processing rating, for item: 10, rating: 5 by user: User 10\n2b. sending sms message, for item: 8, for user: User 8\n2. forming thank-you message, for item: 10\n2b. sending sms message, for item: 10, for user: User 10\n`)),mdx(\"hr\",null),mdx(\"h2\",null,\"Custom coroutine\"),mdx(\"p\",null,\"If you want an asynchronous function in a separate thread with the async capabilities, we can run a coroutine as follows\"),mdx(\"pre\",null,mdx(\"code\",t({parentName:\"pre\"},{className:\"language-python:coroutine.py\"}),`import asyncio\nfrom threading import Thread\nfrom typing import Any, Callable, List, Optional\n\nclass CustomCoroutine(Thread):\n    def __init__(\n        self, \n        is_daemon: bool,\n        callback: Callable[[List[Any]], None], \n        **cbkwargs: Optional[Any]\n    ):\n        Thread.__init__(self)\n        self.daemon = is_daemon\n        self.event_loop = asyncio.new_event_loop()\n        asyncio.set_event_loop(self.event_loop)\n        self.callback = callback\n        self.cbkwargs = cbkwargs\n\n    async def callback(self) -\u003e None:\n        try:\n            await self.callback(**self.cbkwargs)\n        except Exception as e:\n            print(f\"Error calling callback: {e}\")\n\n    def run(self) -\u003e None:\n        try:\n            self.event_loop.run_until_complete(self.callback())\n        finally:\n            self.event_loop.close()\n`)),mdx(\"hr\",null),mdx(\"p\",null,\"I hope the above concurrency patterns give you some understanding of organizing your Python code for better performance and optimization. Other concurrency patterns that are worth noting are:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Monitor pattern\"),\": \",mdx(\"strong\",{parentName:\"li\"},\"n\"),\" number of threads waiting on some condition to be true, if the condition is not true, those threads need to be in a sleep state and pushed to the wait queue, and they have to be notified when the condition becomes true.\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Double Checked locking\"),\": for creating concurrent objects. (Ex: Singleton design pattern)\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Barrier pattern\"),\": All concurrently executing threads must wait for others to complete and wait at a point called barrier.\"),mdx(\"li\",{parentName:\"ul\"},mdx(\"strong\",{parentName:\"li\"},\"Reactor pattern\"),\": In an event-driven system, a service handler accepts events from multiple incoming requests and demultiplexes to respective non-blocking handlers.\")))}MDXContent.isMDXComponent=!0;\n","scope":{}},"id":"concurrency-patterns-python"},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"concurrency-patterns-python"},"buildId":"XKjk8v4y5tDLQXnU9TJA9","runtimeConfig":{},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>